<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><style>body {
  max-width: 980px;
  border: 1px solid #ddd;
  outline: 1300px solid #fff;
  margin: 16px auto;
}

body .markdown-body
{
  padding: 45px;
}

@font-face {
  font-family: fontawesome-mini;
  src: url(data:font/woff;charset=utf-8;base64,d09GRgABAAAAABE0AA8AAAAAHWwAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABHU1VCAAABWAAAADsAAABUIIslek9TLzIAAAGUAAAAQwAAAFY3d1HZY21hcAAAAdgAAACqAAACOvWLi0FjdnQgAAAChAAAABMAAAAgBtX/BGZwZ20AAAKYAAAFkAAAC3CKkZBZZ2FzcAAACCgAAAAIAAAACAAAABBnbHlmAAAIMAAABdQAAAjkYT9TNWhlYWQAAA4EAAAAMwAAADYQ6WvNaGhlYQAADjgAAAAfAAAAJAc6A1pobXR4AAAOWAAAACAAAAA0Kmz/7mxvY2EAAA54AAAAHAAAABwQPBJubWF4cAAADpQAAAAgAAAAIAEHC/NuYW1lAAAOtAAAAYQAAALxhQT4h3Bvc3QAABA4AAAAfgAAAMS3SYh9cHJlcAAAELgAAAB6AAAAhuVBK7x4nGNgZGBg4GIwYLBjYHJx8wlh4MtJLMljkGJgYYAAkDwymzEnMz2RgQPGA8qxgGkOIGaDiAIAJjsFSAB4nGNgZHZmnMDAysDAVMW0h4GBoQdCMz5gMGRkAooysDIzYAUBaa4pDA4Pwz+yMwf9z2KIYg5imAYUZgTJAQDcoQvQAHic7ZHNDYJAFIRnBXf94cDRIiyCKkCpwFCPJ092RcKNDoYKcN4+EmMPvpdvk539zQyAPYBCXEUJhBcCrJ5SQ9YLnLJe4qF5rdb+uWPDngNHTkta101pNyWa8lMhn6xx2dqUnW4q9YOIhAOOeueMSgsR/6ry+P7O5s6xVNg4chBsHUuFnWNJ8uZYwrw7chrsHXkODo7cB0dHOYCTY8kv0VE2WJKD6gOlWjsxAAB4nGNgQAMSEMgc9D8LhAESbAPdAHicrVZpd9NGFB15SZyELCULLWphxMRpsEYmbMGACUGyYyBdnK2VoIsUO+m+8Ynf4F/zZNpz6Dd+Wu8bLySQtOdwmpOjd+fN1czbZRJaktgL65GUmy/F1NYmjew8CemGTctRfCg7eyFlisnfBVEQrZbatx2HREQiULWusEQQ+x5ZmmR86FFGy7akV03KLT3pLlvjQb1V334aOsqxO6GkZjN0aD2yJVUYVaJIpj1S0qZlqPorSSu8v8LMV81QwohOImm8GcbQSN4bZ7TKaDW24yiKbLLcKFIkmuFBFHmU1RLn5IoJDMoHzZDyyqcR5cP8iKzYo5xWsEu20/y+L3mndzk/sV9vUbbkQB/Ijuzg7HQlX4RbW2HctJPtKFQRdtd3QmzZ7FT/Zo/ymkYDtysyvdCMYKl8hRArP6HM/iFZLZxP+ZJHo1qykRNB62VO7Es+gdbjiClxzRhZ0N3RCRHU/ZIzDPaYPh788d4plgsTAngcy3pHJZwIEylhczRJ2jByYCVliyqp9a6YOOV1WsRbwn7t2tGXzmjjUHdiPFsPHVs5UcnxaFKnmUyd2knNoykNopR0JnjMrwMoP6JJXm1jNYmVR9M4ZsaERCICLdxLU0EsO7GkKQTNoxm9uRumuXYtWqTJA/Xco/f05la4udNT2g70s0Z/VqdiOtgL0+lp5C/xadrlIkXp+ukZfkziQdYCMpEtNsOUgwdv/Q7Sy9eWHIXXBtju7fMrqH3WRPCkAfsb0B5P1SkJTIWYVYhWQGKta1mWydWsFqnI1HdDmla+rNMEinIcF8e+jHH9XzMzlpgSvt+J07MjLj1z7UsI0xx8m3U9mtepxXIBcWZ5TqdZlu/rNMfyA53mWZ7X6QhLW6ejLD/UaYHlRzodY3lBC5p038GQizDkAg6QMISlA0NYXoIhLBUMYbkIQ1gWYQjLJRjC8mMYwnIZhrC8rGXV1FNJ49qZWAZsQmBijh65zEXlaiq5VEK7aFRqQ54SbpVUFM+qf2WgXjzyhjmwFkiXyJpfMc6Vj0bl+NYVLW8aO1fAsepvH472OfFS1ouFPwX/1dZUJb1izcOTq/Abhp5sJ6o2qXh0TZfPVT26/l9UVFgL9BtIhVgoyrJscGcihI86nYZqoJVDzGzMPLTrdcuan8P9NzFCFlD9+DcUGgvcg05ZSVnt4KzV19uy3DuDcjgTLEkxN/P6VvgiI7PSfpFZyp6PfB5wBYxKZdhqA60VvNknMQ+Z3iTPBHFbUTZI2tjOBIkNHPOAefOdBCZh6qoN5E7hhg34BWFuwXknXKJ6oyyH7kXs8yik/Fun4kT2qGiMwLPZG2Gv70LKb3EMJDT5pX4MVBWhqRg1FdA0Um6oBl/G2bptQsYO9CMqdsOyrOLDxxb3lZJtGYR8pIjVo6Of1l6iTqrcfmYUl++dvgXBIDUxf3vfdHGQyrtayTJHbQNTtxqVU9eaQ+NVh+rmUfW94+wTOWuabronHnpf06rbwcVcLLD2bQ7SUiYX1PVhhQ2iy8WlUOplNEnvuAcYFhjQ71CKjf+r+th8nitVhdFxJN9O1LfR52AM/A/Yf0f1A9D3Y+hyDS7P95oTn2704WyZrqIX66foNzBrrblZugbc0HQD4iFHrY64yg18pwZxeqS5HOkh4GPdFeIBwCaAxeAT3bWM5lMAo/mMOT7A58xh0GQOgy3mMNhmzhrADnMY7DKHwR5zGHzBnHWAL5nDIGQOg4g5DJ4wJwB4yhwGXzGHwdfMYfANc+4DfMscBjFzGCTMYbCv6dYwzC1e0F2gtkFVoANTT1jcw+JQU2XI/o4Xhv29Qcz+wSCm/qjp9pD6Ey8M9WeDmPqLQUz9VdOdIfU3Xhjq7wYx9Q+DmPpMvxjLZQa/jHyXCgeUXWw+5++J9w/bxUC5AAEAAf//AA94nIVVX2hbZRQ/5/t7893s5ja9f7ouzdZ0TTqz3bRJmogbWya6bG6Cq0VbSV2ddIJjFtfIQHEig80Hda8yUN/0YQz8AyriiyD+xQd92R4HCnaCb3samnpumrpsCsLlfPf7zvedc37nL3CAtc/5W/wQZGA3tOBSY/g+TMjHmwzEoM1Q8+ZjRZY4oJhmBw5/YB6Za0yC5AkhlwA1A1yCBIBOwCII0Cj0U8BAMdUCzq05sKwkP7SlUY6fcJk4Fb/RyE79/6P5hjM/F4aZiXBoeMgzcqQ4Xi1hPqfDLG5FT+lchCVU3lYMyvuwhl1mqndQL0RsuloLywHtthLXI06OblTrhfWVnpSJ5+mwu/JdbtuN3IAnkW0LLMcRwaC7ktrlzridM6kVdyf9uO1UNBByI7JhwtG2sEwab07ORBeilWhqavJCqV0qzZTOl/7ZXQ5TbTcdcFelyGhhRDAQpdqp1FEX3w3cFTc1k9pJQkmm4ySCbSikxRP2QOfN+0tHS5MrpQuTU1Mk5nw0E5Xa0WvrOwDyGax9yB9ma6DAg82wHc43SAGTI4GjBWebOePAERFE8/AHaQpZASSTy8A4WwZiLQMQ82mFKATO0ILicRAoDm9p5P99E5b/fXG+kQYY3TYUuqmERWYoT0u/GNYL2q/4WB3LaVS+VynXsVYIcWw6DkCh3nX1D+VzlYN4LClF5yexSQos8exqZ3KVP+wtrC54u4Nznq6cq+xpMpUUnZ8FUYzE86ud0g28NOIv3Gj5/rmA3ABs7S/ywzFuQ4qyd6QxfNtiQIaEgp3w/entQg4Vcbqa16M5FfpeUB8t1+qeg7mI7cUyOe79wOk86gSxkVec4KPTX69++5x68Yubn5/F+w52z7u08sJX7fZXv8ekT/d2mILJxq6sn+SC6qEJknzLJCxyZEKwWVqYmAPBxBE/9DLeZiWHu7lcr/VytrCRuHojncNuTt9h46tmacmYisnSamdN2bZptcsmSysdVsy1PrOvOzF3xN64Rb937t/og9KHxYdcjIUqFAmIAHGHNzlns+RTPgeUYAQm9DwpNxfxbhhBHPaw3/gfTcXO2L+eJVIx5nsyGkvm9X4/f+bGkH45G0PaSjcMXTjcZyTvi3UdHoCDjQd3IDUVsgwYmUoJK/gp4JJxeRI0MKHZIkgynyIBqBTOUs6rOVCojvjZ4mCQz49ZMlMcp8QoYk6NoBfsxnJtsBohpa8iGJS+ZH7gU7NxME6cmF+t7cO9vB8d3jTWSct0ycW9ranXmolNDwmVkNnxe+8JtoztwS5rKJ0xWS95tQ/1zMYzg69MzUZnNtl1ofNbsml/OJm6f9wjRjpnu2o4MzHzn77IQkRd+1DjwMQ2pqSjGMMhyjrgTbBAKksuUm0iU7hI0aN2wOKOq7WYBSH0HGihj/jkiPxAfmwsEbfYrjMG+j3ij932Db/LV7I/xruNrhnroxjR9HRMb2nTvO0ZXOoHPk8H2ZhDPx93qcE/53sH5np/dkIP7zzhTVKdR/BAY/9ElkkR+A6lJGsqpJ4oQcTxpvBT3Kn58VkaJjgHyPEIws57xkaHh9KuVpDEpJZeMbZ5w/zBHi5NMQ4r5VphsFqID7TyB9eR4pX216c3AHxpdAwoqU9qg0ZJ6yVLKmMSz1iG2z27ifx18NkY0LPx1W/wCc2l5LrznrIsiKsqbmB78A9wIGx4tI8rjihVHJyY9pgMirenVq0yWg7Iw7eogG7ZgYM3qR9959A/fZkg6MnD/exlkmc+jWV4SB15XUR+eqC6l6ZmgPtN9z5JMfik05OV8ljylunJ4J+wA/FUaQSSKotsYsCWqaPBidBLcxkWx7XKFRIb45TGaEhjlF9uUVPqXOtcIwsXbBvfoZXIyRYFdkfnqjExH98xpnPczqzjX/uNdO1Y17Wpi5+6Ts8BXtjVFasp9KZ1mOiNbH65c5w6HgmyF2jFCZywM8mWjRc7T5Pmt0lRy7Y71+jYbpGyvwG4sH0XeJxjYGRgYADiwBB/53h+m68M3MwvgCIM1z5N/g6j///9v5H5BbMnkMvBwAQSBQCIcA9gAHicY2BkYGAO+p8FJF/8//v/F/MLBqAICuAFALYQB5kAeJxjfsHAwLwAiCNB+P9fbJjJmoGBMRUo/wKCAfO2EnQAAAAAANoBXgGcAgICVALaA1IDvAPkBAYEPARyAAEAAAANAF0ABAAAAAAAAgAUACQAcwAAAG4LcAAAAAB4nHWRzWrCQBSFT+pPqUIXLXTTzayKUohGKIibCoLuhbrrYtTRxCYZmYyKyz5Fd32HvlDfoO/QkziIFJtw9bvnnpl7ZwLgBt/wcHieGAf2UGd24Atcou+4RH3kuEweO66QXx1XyaHjGh6ROa7jFp/cwStfMVvhy7GHO+/e8QWuvcBxifqz4zL5xXGF/Oa4Sn53XMPE+3Bcx4P3M9DrvYmWoRWNQVN02kFXTPdCU4pSGQu5saE2meiLhU6timPtz3SSs9ypTCdqrJabWJoT5QQnymSRTkXgt0/UkUqVkVbN807ZdtmxdiEWRidi6HqItdErNbN+aO2612qd9sYAGmvsYRBhyUu0EGhQbfK/gzYCdElTOgSdB1eEFBIxFYkNV4RFJWPeZyyYpVQVHTHZx4y/yVGX2LGWFZri51TccUOn5B7nPefVCSPvGhVVwUl9znveO2KkhV8Wk82PZ8qwZf8OVcu1+fSmWCMw/HMOwXvKaysqM+p+cVuWag8tvv+c+xdd+4+teJxtjUEOwiAURJla24KliQfhUA2g/Sl+CKXx+loNrpzVezOLEY34Ron/0WhwQoszOvQYIKFwwQiNSbSBeO2SZ0tBP4j3zVjKNng32ZmtD1VVXCuOiw/pJ8S3WOU6l+K5UOTaDC4+2TjKMtN9KQf1ezLx/Sg/00FCvABHhjDjAAB4nGPw3sFwIihiIyNjX+QGxp0cDBwMyQUbGVidNjEwMmiBGJu5mBg5ICw+BjCLzWkX0wGgNCeQze60i8EBwmZmcNmowtgRGLHBoSNiI3OKy0Y1EG8XRwMDI4tDR3JIBEhJJBBs5mFi5NHawfi/dQNL70YmBhcADHYj9AAA) format('woff');
}

.markdown-body {
  font-family: sans-serif;
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  color: #333333;
  overflow: hidden;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
}

.markdown-body a {
  background: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline: 0;
}

.markdown-body b,
.markdown-body strong {
  font-weight: bold;
}

.markdown-body mark {
  background: #ff0;
  color: #000;
  font-style: italic;
  font-weight: bold;
}

.markdown-body sub,
.markdown-body sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
.markdown-body sup {
  top: -0.5em;
}
.markdown-body sub {
  bottom: -0.25em;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border: 0;
}

.markdown-body hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}

.markdown-body pre {
  overflow: auto;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre,
.markdown-body samp {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body input {
  color: inherit;
  font: inherit;
  margin: 0;
}

.markdown-body html input[disabled] {
  cursor: default;
}

.markdown-body input {
  line-height: normal;
}

.markdown-body input[type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
}

.markdown-body table {
  border-collapse: collapse;
  border-spacing: 0;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body .codehilitetable {
  border: 0;
  border-spacing: 0;
}

.markdown-body .codehilitetable tr {
  border: 0;
}

.markdown-body .codehilitetable pre,
.markdown-body .codehilitetable div.codehilite {
  margin: 0;
}

.markdown-body .linenos,
.markdown-body .code,
.markdown-body .codehilitetable td {
  border: 0;
  padding: 0;
}

.markdown-body td:not(.linenos) .linenodiv {
  padding: 0 !important;
}

.markdown-body .code {
  width: 100%;
}

.markdown-body .linenos div pre,
.markdown-body .linenodiv pre,
.markdown-body .linenodiv {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-left-radius: 3px;
  -webkit-border-bottom-left-radius: 3px;
  -moz-border-radius-topleft: 3px;
  -moz-border-radius-bottomleft: 3px;
  border-top-left-radius: 3px;
  border-bottom-left-radius: 3px;
}

.markdown-body .code div pre,
.markdown-body .code div {
  border: 0;
  -webkit-border-radius: 0;
  -moz-border-radius: 0;
  border-radius: 0;
  -webkit-border-top-right-radius: 3px;
  -webkit-border-bottom-right-radius: 3px;
  -moz-border-radius-topright: 3px;
  -moz-border-radius-bottomright: 3px;
  border-top-right-radius: 3px;
  border-bottom-right-radius: 3px;
}

.markdown-body * {
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body input {
  font: 13px Helvetica, arial, freesans, clean, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
  line-height: 1.4;
}

.markdown-body a {
  color: #4183c4;
  text-decoration: none;
}

.markdown-body a:hover,
.markdown-body a:focus,
.markdown-body a:active {
  text-decoration: underline;
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid #ddd;
}

.markdown-body hr:before,
.markdown-body hr:after {
  display: table;
  content: " ";
}

.markdown-body hr:after {
  clear: both;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 15px;
  margin-bottom: 15px;
  line-height: 1.1;
}

.markdown-body h1 {
  font-size: 30px;
}

.markdown-body h2 {
  font-size: 21px;
}

.markdown-body h3 {
  font-size: 16px;
}

.markdown-body h4 {
  font-size: 14px;
}

.markdown-body h5 {
  font-size: 12px;
}

.markdown-body h6 {
  font-size: 11px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ul,
.markdown-body ol {
  padding: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code,
.markdown-body pre,
.markdown-body samp {
  font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 12px;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body kbd {
  background-color: #e7e7e7;
  background-image: -moz-linear-gradient(#fefefe, #e7e7e7);
  background-image: -webkit-linear-gradient(#fefefe, #e7e7e7);
  background-image: linear-gradient(#fefefe, #e7e7e7);
  background-repeat: repeat-x;
  border-radius: 2px;
  border: 1px solid #cfcfcf;
  color: #000;
  padding: 3px 5px;
  line-height: 10px;
  font: 11px Consolas, "Liberation Mono", Menlo, Courier, monospace;
  display: inline-block;
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body .headerlink {
  font: normal 400 16px fontawesome-mini;
  vertical-align: middle;
  margin-left: -16px;
  float: left;
  display: inline-block;
  text-decoration: none;
  opacity: 0;
  color: #333;
}

.markdown-body .headerlink:focus {
  outline: none;
}

.markdown-body h1 .headerlink {
  margin-top: 0.8rem;
}

.markdown-body h2 .headerlink,
.markdown-body h3 .headerlink {
  margin-top: 0.6rem;
}

.markdown-body h4 .headerlink {
  margin-top: 0.2rem;
}

.markdown-body h5 .headerlink,
.markdown-body h6 .headerlink {
  margin-top: 0;
}

.markdown-body .headerlink:hover,
.markdown-body h1:hover .headerlink,
.markdown-body h2:hover .headerlink,
.markdown-body h3:hover .headerlink,
.markdown-body h4:hover .headerlink,
.markdown-body h5:hover .headerlink,
.markdown-body h6:hover .headerlink {
  opacity: 1;
  text-decoration: none;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}

.markdown-body h3 {
  font-size: 1.5em;
  line-height: 1.43;
}

.markdown-body h4 {
  font-size: 1.25em;
}

.markdown-body h5 {
  font-size: 1em;
}

.markdown-body h6 {
  font-size: 1em;
  color: #777;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre,
.markdown-body .admonition {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: bold;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
  word-break: normal;
  word-break: keep-all;
}

.markdown-body table th {
  font-weight: bold;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #ddd;
}

.markdown-body table tr {
  background-color: #fff;
  border-top: 1px solid #ccc;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f8f8f8;
}

.markdown-body img {
  max-width: 100%;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

.markdown-body code,
.markdown-body samp {
  padding: 0;
  padding-top: 0.2em;
  padding-bottom: 0.2em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(0,0,0,0.04);
  border-radius: 3px;
}

.markdown-body code:before,
.markdown-body code:after {
  letter-spacing: -0.2em;
  content: "\00a0";
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .codehilite {
  margin-bottom: 16px;
}

.markdown-body .codehilite pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f7f7f7;
  border-radius: 3px;
}

.markdown-body .codehilite pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre code {
  display: inline;
  max-width: initial;
  padding: 0;
  margin: 0;
  overflow: initial;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body pre code:before,
.markdown-body pre code:after {
  content: normal;
}

/* Admonition */
.markdown-body .admonition {
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  position: relative;
  border-radius: 3px;
  border: 1px solid #e0e0e0;
  border-left: 6px solid #333;
  padding: 10px 10px 10px 30px;
}

.markdown-body .admonition table {
  color: #333;
}

.markdown-body .admonition p {
  padding: 0;
}

.markdown-body .admonition-title {
  font-weight: bold;
  margin: 0;
}

.markdown-body .admonition>.admonition-title {
  color: #333;
}

.markdown-body .attention>.admonition-title {
  color: #a6d796;
}

.markdown-body .caution>.admonition-title {
  color: #d7a796;
}

.markdown-body .hint>.admonition-title {
  color: #96c6d7;
}

.markdown-body .danger>.admonition-title {
  color: #c25f77;
}

.markdown-body .question>.admonition-title {
  color: #96a6d7;
}

.markdown-body .note>.admonition-title {
  color: #d7c896;
}

.markdown-body .admonition:before,
.markdown-body .attention:before,
.markdown-body .caution:before,
.markdown-body .hint:before,
.markdown-body .danger:before,
.markdown-body .question:before,
.markdown-body .note:before {
  font: normal normal 16px fontawesome-mini;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  line-height: 1.5;
  color: #333;
  position: absolute;
  left: 0;
  top: 0;
  padding-top: 10px;
  padding-left: 10px;
}

.markdown-body .admonition:before {
  content: "\f056\00a0";
  color: 333;
}

.markdown-body .attention:before {
  content: "\f058\00a0";
  color: #a6d796;
}

.markdown-body .caution:before {
  content: "\f06a\00a0";
  color: #d7a796;
}

.markdown-body .hint:before {
  content: "\f05a\00a0";
  color: #96c6d7;
}

.markdown-body .danger:before {
  content: "\f057\00a0";
  color: #c25f77;
}

.markdown-body .question:before {
  content: "\f059\00a0";
  color: #96a6d7;
}

.markdown-body .note:before {
  content: "\f040\00a0";
  color: #d7c896;
}

.markdown-body .admonition::after {
  content: normal;
}

.markdown-body .attention {
  border-left: 6px solid #a6d796;
}

.markdown-body .caution {
  border-left: 6px solid #d7a796;
}

.markdown-body .hint {
  border-left: 6px solid #96c6d7;
}

.markdown-body .danger {
  border-left: 6px solid #c25f77;
}

.markdown-body .question {
  border-left: 6px solid #96a6d7;
}

.markdown-body .note {
  border-left: 6px solid #d7c896;
}

.markdown-body .admonition>*:first-child {
  margin-top: 0 !important;
}

.markdown-body .admonition>*:last-child {
  margin-bottom: 0 !important;
}

/* progress bar*/
.markdown-body .progress {
  display: block;
  width: 300px;
  margin: 10px 0;
  height: 24px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: #ededed;
  position: relative;
  box-shadow: inset -1px 1px 3px rgba(0, 0, 0, .1);
}

.markdown-body .progress-label {
  position: absolute;
  text-align: center;
  font-weight: bold;
  width: 100%; margin: 0;
  line-height: 24px;
  color: #333;
  text-shadow: 1px 1px 0 #fefefe, -1px -1px 0 #fefefe, -1px 1px 0 #fefefe, 1px -1px 0 #fefefe, 0 1px 0 #fefefe, 0 -1px 0 #fefefe, 1px 0 0 #fefefe, -1px 0 0 #fefefe, 1px 1px 2px #000;
  -webkit-font-smoothing: antialiased !important;
  white-space: nowrap;
  overflow: hidden;
}

.markdown-body .progress-bar {
  height: 24px;
  float: left;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  background-color: #96c6d7;
  box-shadow: inset 0 1px 0 rgba(255, 255, 255, .5), inset 0 -1px 0 rgba(0, 0, 0, .1);
  background-size: 30px 30px;
  background-image: -webkit-linear-gradient(
    135deg, rgba(255, 255, 255, .4) 27%,
    transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%,
    transparent 77%, transparent
  );
  background-image: -moz-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -ms-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: -o-linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
  background-image: linear-gradient(
    135deg,
    rgba(255, 255, 255, .4) 27%, transparent 27%,
    transparent 52%, rgba(255, 255, 255, .4) 52%,
    rgba(255, 255, 255, .4) 77%, transparent 77%,
    transparent
  );
}

.markdown-body .progress-100plus .progress-bar {
  background-color: #a6d796;
}

.markdown-body .progress-80plus .progress-bar {
  background-color: #c6d796;
}

.markdown-body .progress-60plus .progress-bar {
  background-color: #d7c896;
}

.markdown-body .progress-40plus .progress-bar {
  background-color: #d7a796;
}

.markdown-body .progress-20plus .progress-bar {
  background-color: #d796a6;
}

.markdown-body .progress-0plus .progress-bar {
  background-color: #c25f77;
}

.markdown-body .candystripe-animate .progress-bar{
  -webkit-animation: animate-stripes 3s linear infinite;
  -moz-animation: animate-stripes 3s linear infinite;
  animation: animate-stripes 3s linear infinite;
}

@-webkit-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@-moz-keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

@keyframes animate-stripes {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 60px 0;
  }
}

.markdown-body .gloss .progress-bar {
  box-shadow:
    inset 0 4px 12px rgba(255, 255, 255, .7),
    inset 0 -12px 0 rgba(0, 0, 0, .05);
}

/* MultiMarkdown Critic Blocks */
.markdown-body .critic_mark {
  background: #ff0;
}

.markdown-body .critic_delete {
  color: #c82829;
  text-decoration: line-through;
}

.markdown-body .critic_insert {
  color: #718c00 ;
  text-decoration: underline;
}

.markdown-body .critic_comment {
  color: #8e908c;
  font-style: italic;
}

.markdown-body .headeranchor {
  font: normal normal 16px fontawesome-mini;
  line-height: 1;
  display: inline-block;
  text-decoration: none;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.headeranchor:before {
  content: '\e157';
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  margin: 0 4px 0.25em -20px;
  vertical-align: middle;
}

/* Media */
@media only screen and (min-width: 480px) {
  .markdown-body {
    font-size:14px;
  }
}

@media only screen and (min-width: 768px) {
  .markdown-body {
    font-size:16px;
  }
}

@media print {
  .markdown-body * {
    background: transparent !important;
    color: black !important;
    filter:none !important;
    -ms-filter: none !important;
  }

  .markdown-body {
    font-size:12pt;
    max-width:100%;
    outline:none;
    border: 0;
  }

  .markdown-body a,
  .markdown-body a:visited {
    text-decoration: underline;
  }

  .markdown-body .headeranchor-link {
    display: none;
  }

  .markdown-body a[href]:after {
    content: " (" attr(href) ")";
  }

  .markdown-body abbr[title]:after {
    content: " (" attr(title) ")";
  }

  .markdown-body .ir a:after,
  .markdown-body a[href^="javascript:"]:after,
  .markdown-body a[href^="#"]:after {
    content: "";
  }

  .markdown-body pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .markdown-body pre,
  .markdown-body blockquote {
    border: 1px solid #999;
    padding-right: 1em;
    page-break-inside: avoid;
  }

  .markdown-body .progress,
  .markdown-body .progress-bar {
    -moz-box-shadow: none;
    -webkit-box-shadow: none;
    box-shadow: none;
  }

  .markdown-body .progress {
    border: 1px solid #ddd;
  }

  .markdown-body .progress-bar {
    height: 22px;
    border-right: 1px solid #ddd;
  }

  .markdown-body tr,
  .markdown-body img {
    page-break-inside: avoid;
  }

  .markdown-body img {
    max-width: 100% !important;
  }

  .markdown-body p,
  .markdown-body h2,
  .markdown-body h3 {
    orphans: 3;
    widows: 3;
  }

  .markdown-body h2,
  .markdown-body h3 {
    page-break-after: avoid;
  }
}
</style><style>/*GitHub*/
.codehilite {background-color:#fff;color:#333333;}
.codehilite .hll {background-color:#ffffcc;}
.codehilite .c{color:#999988;font-style:italic}
.codehilite .err{color:#a61717;background-color:#e3d2d2}
.codehilite .k{font-weight:bold}
.codehilite .o{font-weight:bold}
.codehilite .cm{color:#999988;font-style:italic}
.codehilite .cp{color:#999999;font-weight:bold}
.codehilite .c1{color:#999988;font-style:italic}
.codehilite .cs{color:#999999;font-weight:bold;font-style:italic}
.codehilite .gd{color:#000000;background-color:#ffdddd}
.codehilite .ge{font-style:italic}
.codehilite .gr{color:#aa0000}
.codehilite .gh{color:#999999}
.codehilite .gi{color:#000000;background-color:#ddffdd}
.codehilite .go{color:#888888}
.codehilite .gp{color:#555555}
.codehilite .gs{font-weight:bold}
.codehilite .gu{color:#800080;font-weight:bold}
.codehilite .gt{color:#aa0000}
.codehilite .kc{font-weight:bold}
.codehilite .kd{font-weight:bold}
.codehilite .kn{font-weight:bold}
.codehilite .kp{font-weight:bold}
.codehilite .kr{font-weight:bold}
.codehilite .kt{color:#445588;font-weight:bold}
.codehilite .m{color:#009999}
.codehilite .s{color:#dd1144}
.codehilite .n{color:#333333}
.codehilite .na{color:teal}
.codehilite .nb{color:#0086b3}
.codehilite .nc{color:#445588;font-weight:bold}
.codehilite .no{color:teal}
.codehilite .ni{color:purple}
.codehilite .ne{color:#990000;font-weight:bold}
.codehilite .nf{color:#990000;font-weight:bold}
.codehilite .nn{color:#555555}
.codehilite .nt{color:navy}
.codehilite .nv{color:teal}
.codehilite .ow{font-weight:bold}
.codehilite .w{color:#bbbbbb}
.codehilite .mf{color:#009999}
.codehilite .mh{color:#009999}
.codehilite .mi{color:#009999}
.codehilite .mo{color:#009999}
.codehilite .sb{color:#dd1144}
.codehilite .sc{color:#dd1144}
.codehilite .sd{color:#dd1144}
.codehilite .s2{color:#dd1144}
.codehilite .se{color:#dd1144}
.codehilite .sh{color:#dd1144}
.codehilite .si{color:#dd1144}
.codehilite .sx{color:#dd1144}
.codehilite .sr{color:#009926}
.codehilite .s1{color:#dd1144}
.codehilite .ss{color:#990073}
.codehilite .bp{color:#999999}
.codehilite .vc{color:teal}
.codehilite .vg{color:teal}
.codehilite .vi{color:teal}
.codehilite .il{color:#009999}
.codehilite .gc{color:#999;background-color:#EAF2F5}
</style><title>Flink-on-yarn(per-job与session)</title></head><body><article class="markdown-body"><h3 id="flink-on-yarnper-jobsession">Flink-on-yarn(per-job与session)<a class="headerlink" href="#flink-on-yarnper-jobsession" title="Permanent link"></a></h3>
<ul>
<li>1、面试题：</li>
<li>2、简介</li>
<li>3、Session-Cluster模式：</li>
<li>4、Per-Job-Cluster模式：</li>
</ul>
<h3 id="1">1、面试题目<a class="headerlink" href="#1" title="Permanent link"></a></h3>
<ol>
<li>听说你熟悉Flink-on-yarn的部署模式？</li>
<li>讲讲flink-on-yarn？flink与yarn的关系？部署在yarn上比standalone的优点？</li>
</ol>
<h3 id="2">2、简介<a class="headerlink" href="#2" title="Permanent link"></a></h3>
<p>Flink提供了两种在yarn上运行的模式，分别为Session-cluster和Per-Job-Cluster模式，本文分析两种模式及启动流程。</p>
<p>下面展示了Flink-On-Yarn模式下涉及到的相关类图结构：</p>
<p><img alt="" src="/Users/liaomengjie/workspace/learngit/leetcode/todo/Flink/Flink%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%BC%8F%E7%B1%BB%E5%9B%BE.png" /></p>
<h3 id="3session-cluster">3、Session-Cluster模式：<a class="headerlink" href="#3session-cluster" title="Permanent link"></a></h3>
<p>session-Cluster模式 <strong><em>需要先启动集群，然后再提交作业</em></strong>，接着会向yarn申请一块空间后，资源永远保持不变。如果资源满了，下一个作业就无法提交，只能等到yarn中的其中一个作业执行完成后，释放了资源，下一个作业才会正常提交。<strong><em>所有作业共享Dispatcher和ResourceManager</em></strong>；共享资源，适合规模小执行时间短的作业。</p>
<p><img alt="" src="/Users/liaomengjie/workspace/learngit/leetcode/todo/Flink/YarnSession%E6%A8%A1%E5%BC%8F.png" /></p>
<h4 id="31">3.1、启动集群<a class="headerlink" href="#31" title="Permanent link"></a></h4>
<p>运行bin/yarn-session.sh，即可默认启动包含一个TaskManager(内存大小为1024MB),一个JobMaster(内存大小为1024MB)，当然可以通过指定参数控制集群的资源，如-n执行taskManager个数，-s指定每个TaskManager中slot的个数；</p>
<p>下面以bin/yarn-session.sh为例，分析Session-Cluster启动流程</p>
<h4 id="32">3.2、流程分析<a class="headerlink" href="#32" title="Permanent link"></a></h4>
<p>下面分为 <strong><em>本地和远程</em></strong>分析启动流程，其中本地表示客户端的启动流程，远程则表示通过Yarn拉起Container的流程；</p>
<h5 id="321">3.2.1、本地流程<a class="headerlink" href="#321" title="Permanent link"></a></h5>
<p>Session启动入口为FlinkYarnSessionCli#main</p>
<p><div class="codehilite"><pre><span class="n">FlinkYarnSessionCli</span><span class="o">.</span><span class="na">java</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">configurationDirectory</span> <span class="o">=</span> <span class="n">CliFrontend</span><span class="o">.</span><span class="na">getConfigurationDirectoryFromEnv</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">Configuration</span> <span class="n">flinkConfiguration</span> <span class="o">=</span> <span class="n">GlobalConfiguration</span><span class="o">.</span><span class="na">loadConfiguration</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">retCode</span><span class="o">;</span>
<span class="c1">//new FlinkYarnSessionCli对象</span>
<span class="err">★</span>    <span class="kd">final</span> <span class="n">FlinkYarnSessionCli</span> <span class="n">cli</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FlinkYarnSessionCli</span><span class="o">(</span>
        <span class="n">flinkConfiguration</span><span class="o">,</span>
        <span class="n">configurationDirectory</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">,</span><span class="s">&quot;&quot;</span><span class="o">);</span> <span class="c1">// no prefix for the YARN session</span>

    <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">install</span><span class="o">(</span><span class="k">new</span> <span class="n">SecurityConfiguration</span><span class="o">(</span><span class="n">flinkConfiguration</span><span class="o">));</span>
    <span class="n">retCode</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getInstalledContext</span><span class="o">().</span><span class="na">runSecured</span><span class="o">(</span>
<span class="c1">//执行FlinkYarnSessionCli#run方法启动 Flink Session Client</span>
<span class="err">★</span>        <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">cli</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">));</span>
    <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">retCode</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
执行FlinkYarnSessionCli#run
<div class="codehilite"><pre><span class="kd">public</span> <span class="kt">int</span> <span class="nf">run</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">CliArgsException</span><span class="o">,</span> <span class="n">FlinkException</span> <span class="o">{</span>
    <span class="c1">//  Command Line Options</span>
    <span class="kd">final</span> <span class="n">CommandLine</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">parseCommandLineOptions</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">Configuration</span> <span class="n">configuration</span> <span class="o">=</span> <span class="n">applyCommandLineOptionsToConfiguration</span><span class="o">(</span><span class="n">cmd</span><span class="o">);</span>
    <span class="c1">//ClusterClientFactory: 集群Client工厂模式</span>
    <span class="kd">final</span> <span class="n">ClusterClientFactory</span><span class="o">&lt;</span><span class="n">ApplicationId</span><span class="o">&gt;</span> <span class="n">yarnClusterClientFactory</span> <span class="o">=</span> <span class="n">clusterClientServiceLoader</span><span class="o">.</span><span class="na">getClusterClientFactory</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
    <span class="c1">//The descriptor with deployment information for deploying a Flink cluster on Yarn:</span>
<span class="err">★</span>    <span class="kd">final</span> <span class="n">YarnClusterDescriptor</span> <span class="n">yarnClusterDescriptor</span> <span class="o">=</span> <span class="o">(</span><span class="n">YarnClusterDescriptor</span><span class="o">)</span> <span class="n">yarnClusterClientFactory</span><span class="o">.</span><span class="na">createClusterDescriptor</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// Query cluster for metrics</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cmd</span><span class="o">.</span><span class="na">hasOption</span><span class="o">(</span><span class="n">query</span><span class="o">.</span><span class="na">getOpt</span><span class="o">()))</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">String</span> <span class="n">description</span> <span class="o">=</span> <span class="n">yarnClusterDescriptor</span><span class="o">.</span><span class="na">getClusterDescription</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">description</span><span class="o">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">ClusterClientProvider</span><span class="o">&lt;</span><span class="n">ApplicationId</span><span class="o">&gt;</span> <span class="n">clusterClientProvider</span><span class="o">;</span>
            <span class="kd">final</span> <span class="n">ApplicationId</span> <span class="n">yarnApplicationId</span><span class="o">;</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">cmd</span><span class="o">.</span><span class="na">hasOption</span><span class="o">(</span><span class="n">applicationId</span><span class="o">.</span><span class="na">getOpt</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">yarnApplicationId</span> <span class="o">=</span> <span class="n">ConverterUtils</span><span class="o">.</span><span class="na">toApplicationId</span><span class="o">(</span><span class="n">cmd</span><span class="o">.</span><span class="na">getOptionValue</span><span class="o">(</span><span class="n">applicationId</span><span class="o">.</span><span class="na">getOpt</span><span class="o">()));</span>

                <span class="n">clusterClientProvider</span> <span class="o">=</span> <span class="n">yarnClusterDescriptor</span><span class="o">.</span><span class="na">retrieve</span><span class="o">(</span><span class="n">yarnApplicationId</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="n">ClusterSpecification</span> <span class="n">clusterSpecification</span> <span class="o">=</span> <span class="n">yarnClusterClientFactory</span><span class="o">.</span><span class="na">getClusterSpecification</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
<span class="c1">//deploy yarn Cluster集群</span>
<span class="err">★</span>                <span class="n">clusterClientProvider</span> <span class="o">=</span> <span class="n">yarnClusterDescriptor</span><span class="o">.</span><span class="na">deploySessionCluster</span><span class="o">(</span><span class="n">clusterSpecification</span><span class="o">);</span>
<span class="c1">//创建与集群交互的ClusterClient</span>
<span class="err">★</span>                <span class="n">ClusterClient</span><span class="o">&lt;</span><span class="n">ApplicationId</span><span class="o">&gt;</span> <span class="n">clusterClient</span> <span class="o">=</span> <span class="n">clusterClientProvider</span><span class="o">.</span><span class="na">getClusterClient</span><span class="o">();</span>

                <span class="c1">//--- ClusterClient deployed, handle connection details</span>
<span class="err">★</span>                <span class="n">yarnApplicationId</span> <span class="o">=</span> <span class="n">clusterClient</span><span class="o">.</span><span class="na">getClusterId</span><span class="o">();</span>

                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;JobManager Web Interface: &quot;</span> <span class="o">+</span> <span class="n">clusterClient</span><span class="o">.</span><span class="na">getWebInterfaceURL</span><span class="o">());</span>

                <span class="n">writeYarnPropertiesFile</span><span class="o">(</span>
                    <span class="n">yarnApplicationId</span><span class="o">,</span>
                    <span class="n">dynamicPropertiesEncoded</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(!</span><span class="n">configuration</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="n">DeploymentOptions</span><span class="o">.</span><span class="na">ATTACHED</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">YarnClusterDescriptor</span><span class="o">.</span><span class="na">logDetachedClusterInformation</span><span class="o">(</span><span class="n">yarnApplicationId</span><span class="o">,</span> <span class="n">LOG</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">ScheduledExecutorService</span> <span class="n">scheduledExecutorService</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newSingleThreadScheduledExecutor</span><span class="o">();</span>

                <span class="kd">final</span> <span class="n">YarnApplicationStatusMonitor</span> <span class="n">yarnApplicationStatusMonitor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">YarnApplicationStatusMonitor</span><span class="o">(</span>
                    <span class="n">yarnClusterDescriptor</span><span class="o">.</span><span class="na">getYarnClient</span><span class="o">(),</span>
                    <span class="n">yarnApplicationId</span><span class="o">,</span>
                    <span class="k">new</span> <span class="n">ScheduledExecutorServiceAdapter</span><span class="o">(</span><span class="n">scheduledExecutorService</span><span class="o">));</span>
                <span class="n">Thread</span> <span class="n">shutdownHook</span> <span class="o">=</span> <span class="n">ShutdownHookUtil</span><span class="o">.</span><span class="na">addShutdownHook</span><span class="o">(</span>
                    <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">shutdownCluster</span><span class="o">(</span>
                            <span class="n">clusterClientProvider</span><span class="o">.</span><span class="na">getClusterClient</span><span class="o">(),</span>
                            <span class="n">scheduledExecutorService</span><span class="o">,</span>
                            <span class="n">yarnApplicationStatusMonitor</span><span class="o">),</span>
                            <span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span>
                            <span class="n">LOG</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">runInteractiveCli</span><span class="o">(</span>
                        <span class="n">yarnApplicationStatusMonitor</span><span class="o">,</span>
                        <span class="n">acceptInteractiveInput</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">shutdownCluster</span><span class="o">(</span>
                            <span class="n">clusterClientProvider</span><span class="o">.</span><span class="na">getClusterClient</span><span class="o">(),</span>
                            <span class="n">scheduledExecutorService</span><span class="o">,</span>
                            <span class="n">yarnApplicationStatusMonitor</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">shutdownHook</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">ShutdownHookUtil</span><span class="o">.</span><span class="na">removeShutdownHook</span><span class="o">(</span><span class="n">shutdownHook</span><span class="o">,</span> <span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">LOG</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">tryRetrieveAndLogApplicationReport</span><span class="o">(</span>
                        <span class="n">yarnClusterDescriptor</span><span class="o">.</span><span class="na">getYarnClient</span><span class="o">(),</span>
                        <span class="n">yarnApplicationId</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">yarnClusterDescriptor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
上述代码中：yarnClusterClientFactory.createClusterDescriptor(configuration)&ndash;=》yarnClusterClientFactory#getClusterDescription()&mdash;》创建、初始化YarnClient并start
<div class="codehilite"><pre><span class="kd">private</span> <span class="n">YarnClusterDescriptor</span> <span class="nf">getClusterDescriptor</span><span class="o">(</span><span class="n">Configuration</span> <span class="n">configuration</span><span class="o">)</span> <span class="o">{</span>
<span class="c1">//初始化yarn</span>
<span class="err">★</span>    <span class="kd">final</span> <span class="n">YarnClient</span> <span class="n">yarnClient</span> <span class="o">=</span> <span class="n">YarnClient</span><span class="o">.</span><span class="na">createYarnClient</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">YarnConfiguration</span> <span class="n">yarnConfiguration</span> <span class="o">=</span> <span class="k">new</span> <span class="n">YarnConfiguration</span><span class="o">();</span>

<span class="err">★</span>    <span class="n">yarnClient</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">yarnConfiguration</span><span class="o">);</span>
<span class="err">★</span>    <span class="n">yarnClient</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">YarnClusterDescriptor</span><span class="o">(</span>
            <span class="n">configuration</span><span class="o">,</span>
            <span class="n">yarnConfiguration</span><span class="o">,</span>
            <span class="n">yarnClient</span><span class="o">,</span>
            <span class="n">YarnClientYarnClusterInformationRetriever</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">yarnClient</span><span class="o">),</span>
            <span class="kc">false</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></p>
<p>部署集群YarnClusterDescriptor#deploySessionCluster()-&gt;YarnClusterDescriptor#deployInternal()
<div class="codehilite"><pre><span class="n">YarnClusterDescriptor</span><span class="o">.</span><span class="na">java</span>
<span class="cm">/**</span>
<span class="cm"> * deployInternal()方法将一直被阻塞直到ApplicationMaster/JobManager被部署到YARN之前</span>
<span class="cm"> * @param clusterSpecification</span>
<span class="cm"> * @param applicationName 将要启动的集群的名字</span>
<span class="cm"> * @param yarnClusterEntrypoint 类名关于：Yarn cluster entry point</span>
<span class="cm"> * @param jobGraph</span>
<span class="cm"> * @param detached 是否是分离模式</span>
<span class="cm"> */</span>
<span class="kd">private</span> <span class="n">ClusterClientProvider</span><span class="o">&lt;</span><span class="n">ApplicationId</span><span class="o">&gt;</span> <span class="nf">deployInternal</span><span class="o">(</span>
        <span class="n">ClusterSpecification</span> <span class="n">clusterSpecification</span><span class="o">,</span>
        <span class="n">String</span> <span class="n">applicationName</span><span class="o">,</span>
        <span class="n">String</span> <span class="n">yarnClusterEntrypoint</span><span class="o">,</span>
        <span class="nd">@Nullable</span> <span class="n">JobGraph</span> <span class="n">jobGraph</span><span class="o">,</span>
        <span class="kt">boolean</span> <span class="n">detached</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="c1">//判断部署yarn集群的配置参数是否已经配置好</span>
    <span class="n">isReadyForDeployment</span><span class="o">(</span><span class="n">clusterSpecification</span><span class="o">);</span>
    <span class="c1">//检查当前的yarn session是否已经存在yarnQueue</span>
    <span class="n">checkYarnQueues</span><span class="o">(</span><span class="n">yarnClient</span><span class="o">);</span>

    <span class="c1">// Create application via yarnClient</span>
    <span class="kd">final</span> <span class="n">YarnClientApplication</span> <span class="n">yarnApplication</span> <span class="o">=</span> <span class="n">yarnClient</span><span class="o">.</span><span class="na">createApplication</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">GetNewApplicationResponse</span> <span class="n">appResponse</span> <span class="o">=</span> <span class="n">yarnApplication</span><span class="o">.</span><span class="na">getNewApplicationResponse</span><span class="o">();</span>

    <span class="n">Resource</span> <span class="n">maxRes</span> <span class="o">=</span> <span class="n">appResponse</span><span class="o">.</span><span class="na">getMaximumResourceCapability</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">ClusterResourceDescription</span> <span class="n">freeClusterMem</span><span class="o">;</span>
    <span class="n">freeClusterMem</span> <span class="o">=</span> <span class="n">getCurrentFreeClusterResources</span><span class="o">(</span><span class="n">yarnClient</span><span class="o">);</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">yarnMinAllocationMB</span> <span class="o">=</span> <span class="n">yarnConfiguration</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="n">YarnConfiguration</span><span class="o">.</span><span class="na">RM_SCHEDULER_MINIMUM_ALLOCATION_MB</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">ClusterSpecification</span> <span class="n">validClusterSpecification</span><span class="o">;</span>
    <span class="n">validClusterSpecification</span> <span class="o">=</span> <span class="n">validateClusterResources</span><span class="o">(</span>
            <span class="n">clusterSpecification</span><span class="o">,</span>
            <span class="n">yarnMinAllocationMB</span><span class="o">,</span>
            <span class="n">maxRes</span><span class="o">,</span>
            <span class="n">freeClusterMem</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">ClusterEntrypoint</span><span class="o">.</span><span class="na">ExecutionMode</span> <span class="n">executionMode</span> <span class="o">=</span> <span class="n">detached</span> <span class="o">?</span>
            <span class="n">ClusterEntrypoint</span><span class="o">.</span><span class="na">ExecutionMode</span><span class="o">.</span><span class="na">DETACHED</span>
            <span class="o">:</span> <span class="n">ClusterEntrypoint</span><span class="o">.</span><span class="na">ExecutionMode</span><span class="o">.</span><span class="na">NORMAL</span><span class="o">;</span>
    <span class="n">flinkConfiguration</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">ClusterEntrypoint</span><span class="o">.</span><span class="na">EXECUTION_MODE</span><span class="o">,</span> <span class="n">executionMode</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
<span class="c1">//启动AppMaster</span>
<span class="err">★</span>    <span class="n">ApplicationReport</span> <span class="n">report</span> <span class="o">=</span> <span class="n">startAppMaster</span><span class="o">(</span>
            <span class="n">flinkConfiguration</span><span class="o">,</span>
            <span class="n">applicationName</span><span class="o">,</span>
            <span class="n">yarnClusterEntrypoint</span><span class="o">,</span>
            <span class="n">jobGraph</span><span class="o">,</span>
            <span class="n">yarnClient</span><span class="o">,</span>
            <span class="n">yarnApplication</span><span class="o">,</span>
            <span class="n">validClusterSpecification</span><span class="o">);</span>

    <span class="c1">// 如果是分离模式则取出ApplicationID并打印</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">detached</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">ApplicationId</span> <span class="n">yarnApplicationId</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="na">getApplicationId</span><span class="o">();</span>
        <span class="n">logDetachedClusterInformation</span><span class="o">(</span><span class="n">yarnApplicationId</span><span class="o">,</span> <span class="n">LOG</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//AppMaster启动成功后将对应的ip和port写入flinkConfiguration中</span>
    <span class="n">setClusterEntrypointInfoToConfig</span><span class="o">(</span><span class="n">report</span><span class="o">);</span>

    <span class="k">return</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="c1">//创建与集群交互的ClusterClient</span>
        <span class="c1">//通过ClusterClient获取到appId信息并写入本地临时文件</span>
<span class="err">★</span>       <span class="k">return</span> <span class="k">new</span> <span class="n">RestClusterClient</span><span class="o">&lt;&gt;(</span><span class="n">flinkConfiguration</span><span class="o">,</span> <span class="n">report</span><span class="o">.</span><span class="na">getApplicationId</span><span class="o">());</span>
    <span class="o">};</span>
    <span class="c1">// 经过上述步骤，整个客户端的启动流程就结束了，下面分析yarn拉起Session集群的流程，</span>
    <span class="c1">// 入口类在申请Container时指定为YarnSessionClusterEntrypoint</span>
<span class="o">}</span>
</pre></div></p>
<p><div class="codehilite"><pre><span class="n">YarnClusterDescriptor</span><span class="o">.</span><span class="na">java</span>
<span class="kd">private</span> <span class="n">ApplicationReport</span> <span class="nf">startAppMaster</span><span class="o">(</span>
        <span class="n">Configuration</span> <span class="n">configuration</span><span class="o">,</span> <span class="n">String</span> <span class="n">applicationName</span><span class="o">,</span>
        <span class="n">String</span> <span class="n">yarnClusterEntrypoint</span><span class="o">,</span> <span class="n">JobGraph</span> <span class="n">jobGraph</span><span class="o">,</span>
        <span class="n">YarnClient</span> <span class="n">yarnClient</span><span class="o">,</span> <span class="n">YarnClientApplication</span> <span class="n">yarnApplication</span><span class="o">,</span>
        <span class="n">ClusterSpecification</span> <span class="n">clusterSpecification</span><span class="o">){</span>
    <span class="c1">//1. 初始化文件系统（HDFS）</span>
    <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">flink</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">fs</span><span class="o">.</span><span class="na">FileSystem</span><span class="o">.</span><span class="na">initialize</span><span class="o">(</span>
            <span class="n">configuration</span><span class="o">,</span>
            <span class="n">PluginUtils</span><span class="o">.</span><span class="na">createPluginManagerFromRootFolder</span><span class="o">(</span><span class="n">configuration</span><span class="o">));</span>
    <span class="kd">final</span> <span class="n">FileSystem</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">FileSystem</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">yarnConfiguration</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">Path</span> <span class="n">homeDir</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="na">getHomeDirectory</span><span class="o">();</span>
    <span class="c1">//2. 创建appContext 提交启动yarn集群的上下文ApplicationSubmissionContext</span>
    <span class="n">ApplicationSubmissionContext</span> <span class="n">appContext</span> <span class="o">=</span> <span class="n">yarnApplication</span><span class="o">.</span><span class="na">getApplicationSubmissionContext</span><span class="o">();</span>
    <span class="c1">// The files need to be shipped and added to classpath.</span>
    <span class="n">Set</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">systemShipFiles</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;(</span><span class="n">shipFiles</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="c1">// The files only need to be shipped.</span>
    <span class="n">Set</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">shipOnlyFiles</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;&gt;();</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">File</span> <span class="n">file</span> <span class="o">:</span> <span class="n">shipFiles</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">systemShipFiles</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getAbsoluteFile</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="c1">//2. 将log4j、logback、flink-conf.yaml、jar包上传至HDFS</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">logConfigFilePath</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">YarnConfigOptionsInternal</span><span class="o">.</span><span class="na">APPLICATION_LOG_CONFIG_FILE</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">logConfigFilePath</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">systemShipFiles</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">logConfigFilePath</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="n">addLibFoldersToShipFiles</span><span class="o">(</span><span class="n">systemShipFiles</span><span class="o">);</span>
    <span class="n">addPluginsFoldersToShipFiles</span><span class="o">(</span><span class="n">shipOnlyFiles</span><span class="o">);</span>

    <span class="c1">// 3. 生成ApplicationID</span>
    <span class="kd">final</span> <span class="n">ApplicationId</span> <span class="n">appId</span> <span class="o">=</span> <span class="n">appContext</span><span class="o">.</span><span class="na">getApplicationId</span><span class="o">();</span>

    <span class="c1">// -- Add Zookeeper namespace to local flinkConfiguraton ----</span>
    <span class="n">String</span> <span class="n">zkNamespace</span> <span class="o">=</span> <span class="n">getZookeeperNamespace</span><span class="o">();</span>
    <span class="n">configuration</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">HighAvailabilityOptions</span><span class="o">.</span><span class="na">HA_CLUSTER_ID</span><span class="o">,</span> <span class="n">zkNamespace</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">HighAvailabilityMode</span><span class="o">.</span><span class="na">isHighAvailabilityModeActivated</span><span class="o">(</span><span class="n">configuration</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// activate re-execution of failed applications</span>
        <span class="n">appContext</span><span class="o">.</span><span class="na">setMaxAppAttempts</span><span class="o">(</span>
                <span class="n">configuration</span><span class="o">.</span><span class="na">getInteger</span><span class="o">(</span>
                        <span class="n">YarnConfigOptions</span><span class="o">.</span><span class="na">APPLICATION_ATTEMPTS</span><span class="o">.</span><span class="na">key</span><span class="o">(),</span>
                        <span class="n">YarnConfiguration</span><span class="o">.</span><span class="na">DEFAULT_RM_AM_MAX_ATTEMPTS</span><span class="o">));</span>
        <span class="n">activateHighAvailabilitySupport</span><span class="o">(</span><span class="n">appContext</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">appContext</span><span class="o">.</span><span class="na">setMaxAppAttempts</span><span class="o">(</span>
                <span class="n">configuration</span><span class="o">.</span><span class="na">getInteger</span><span class="o">(</span>
                        <span class="n">YarnConfigOptions</span><span class="o">.</span><span class="na">APPLICATION_ATTEMPTS</span><span class="o">.</span><span class="na">key</span><span class="o">(),</span>
                        <span class="mi">1</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">userJarFiles</span> <span class="o">=</span> <span class="o">(</span><span class="n">jobGraph</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="c1">// not per-job submission</span>
            <span class="o">?</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptySet</span><span class="o">()</span>
            <span class="c1">// add user code jars from the provided JobGraph</span>
            <span class="o">:</span> <span class="n">jobGraph</span><span class="o">.</span><span class="na">getUserJars</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="o">.</span><span class="na">toUri</span><span class="o">()).</span><span class="na">map</span><span class="o">(</span><span class="n">File</span><span class="o">::</span><span class="k">new</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toSet</span><span class="o">());</span>

    <span class="c1">// only for per job mode</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">jobGraph</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">DistributedCache</span><span class="o">.</span><span class="na">DistributedCacheEntry</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">jobGraph</span><span class="o">.</span><span class="na">getUserArtifacts</span><span class="o">().</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">flink</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">fs</span><span class="o">.</span><span class="na">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">flink</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">fs</span><span class="o">.</span><span class="na">Path</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">filePath</span><span class="o">);</span>
            <span class="c1">// only upload local files</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">path</span><span class="o">.</span><span class="na">getFileSystem</span><span class="o">().</span><span class="na">isDistributedFS</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">Path</span> <span class="n">localPath</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Path</span><span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">getPath</span><span class="o">());</span>
                <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">remoteFileInfo</span> <span class="o">=</span>
                    <span class="n">Utils</span><span class="o">.</span><span class="na">uploadLocalFileToRemote</span><span class="o">(</span><span class="n">fs</span><span class="o">,</span> <span class="n">appId</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">localPath</span><span class="o">,</span> <span class="n">homeDir</span><span class="o">,</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">());</span>
                <span class="n">jobGraph</span><span class="o">.</span><span class="na">setUserArtifactRemotePath</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">remoteFileInfo</span><span class="o">.</span><span class="na">f0</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="n">jobGraph</span><span class="o">.</span><span class="na">writeUserArtifactEntriesToConfiguration</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// local resource map for Yarn</span>
    <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">LocalResource</span><span class="o">&gt;</span> <span class="n">localResources</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">systemShipFiles</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="n">userJarFiles</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="c1">// list of remote paths (after upload)</span>
    <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="n">paths</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">systemShipFiles</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="n">userJarFiles</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="c1">// ship list that enables reuse of resources for task manager containers</span>
    <span class="n">StringBuilder</span> <span class="n">envShipFileList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>

    <span class="c1">// upload and register ship files, these files will be added to classpath.</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">systemClassPaths</span> <span class="o">=</span> <span class="n">uploadAndRegisterFiles</span><span class="o">(</span>
        <span class="n">systemShipFiles</span><span class="o">,</span> <span class="n">fs</span><span class="o">,</span> <span class="n">homeDir</span><span class="o">,</span> <span class="n">appId</span><span class="o">,</span> <span class="n">paths</span><span class="o">,</span>
        <span class="n">localResources</span><span class="o">,</span> <span class="n">Path</span><span class="o">.</span><span class="na">CUR_DIR</span><span class="o">,</span> <span class="n">envShipFileList</span><span class="o">);</span>
    <span class="c1">//上传和注册ship-only files</span>
    <span class="n">uploadAndRegisterFiles</span><span class="o">(</span>
        <span class="n">shipOnlyFiles</span><span class="o">,</span> <span class="n">fs</span><span class="o">,</span> <span class="n">homeDir</span><span class="o">,</span> <span class="n">appId</span><span class="o">,</span>
        <span class="n">paths</span><span class="o">,</span> <span class="n">localResources</span><span class="o">,</span> <span class="n">Path</span><span class="o">.</span><span class="na">CUR_DIR</span><span class="o">,</span> <span class="n">envShipFileList</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">userClassPaths</span> <span class="o">=</span> <span class="n">uploadAndRegisterFiles</span><span class="o">(</span>
        <span class="n">userJarFiles</span><span class="o">,</span> <span class="n">fs</span><span class="o">,</span> <span class="n">homeDir</span><span class="o">,</span>
        <span class="n">appId</span><span class="o">,</span> <span class="n">paths</span><span class="o">,</span> <span class="n">localResources</span><span class="o">,</span>
        <span class="n">userJarInclusion</span> <span class="o">==</span> <span class="n">YarnConfigOptions</span><span class="o">.</span><span class="na">UserJarInclusion</span><span class="o">.</span><span class="na">DISABLED</span> <span class="o">?</span>
            <span class="n">ConfigConstants</span><span class="o">.</span><span class="na">DEFAULT_FLINK_USR_LIB_DIR</span> <span class="o">:</span> <span class="n">Path</span><span class="o">.</span><span class="na">CUR_DIR</span><span class="o">,</span>
        <span class="n">envShipFileList</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">userJarInclusion</span> <span class="o">==</span> <span class="n">YarnConfigOptions</span><span class="o">.</span><span class="na">UserJarInclusion</span><span class="o">.</span><span class="na">ORDER</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">systemClassPaths</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">userClassPaths</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// normalize classpath by sorting</span>
    <span class="n">Collections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">systemClassPaths</span><span class="o">);</span>
    <span class="n">Collections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">userClassPaths</span><span class="o">);</span>

    <span class="c1">// classpath assembler</span>
    <span class="n">StringBuilder</span> <span class="n">classPathBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">userJarInclusion</span> <span class="o">==</span> <span class="n">YarnConfigOptions</span><span class="o">.</span><span class="na">UserJarInclusion</span><span class="o">.</span><span class="na">FIRST</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">userClassPath</span> <span class="o">:</span> <span class="n">userClassPaths</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">classPathBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">userClassPath</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">File</span><span class="o">.</span><span class="na">pathSeparator</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">classPath</span> <span class="o">:</span> <span class="n">systemClassPaths</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">classPathBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">classPath</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">File</span><span class="o">.</span><span class="na">pathSeparator</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// Setup jar for ApplicationMaster</span>
    <span class="n">Path</span> <span class="n">remotePathJar</span> <span class="o">=</span> <span class="n">setupSingleLocalResource</span><span class="o">(</span>
            <span class="n">flinkJarPath</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">fs</span><span class="o">,</span> <span class="n">appId</span><span class="o">,</span> <span class="n">flinkJarPath</span><span class="o">,</span>
            <span class="n">localResources</span><span class="o">,</span> <span class="n">homeDir</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">);</span>
    <span class="n">paths</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">remotePathJar</span><span class="o">);</span>
    <span class="n">classPathBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">flinkJarPath</span><span class="o">.</span><span class="na">getName</span><span class="o">()).</span><span class="na">append</span><span class="o">(</span><span class="n">File</span><span class="o">.</span><span class="na">pathSeparator</span><span class="o">);</span>

    <span class="c1">// Upload the flink configuration</span>
    <span class="c1">// write out configuration file</span>
    <span class="n">File</span> <span class="n">tmpConfigurationFile</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">tmpConfigurationFile</span> <span class="o">=</span> <span class="n">File</span><span class="o">.</span><span class="na">createTempFile</span><span class="o">(</span><span class="n">appId</span> <span class="o">+</span> <span class="s">&quot;-flink-conf.yaml&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="n">BootstrapTools</span><span class="o">.</span><span class="na">writeConfiguration</span><span class="o">(</span><span class="n">configuration</span><span class="o">,</span> <span class="n">tmpConfigurationFile</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">flinkConfigKey</span> <span class="o">=</span> <span class="s">&quot;flink-conf.yaml&quot;</span><span class="o">;</span>
        <span class="n">Path</span> <span class="n">remotePathConf</span> <span class="o">=</span> <span class="n">setupSingleLocalResource</span><span class="o">(</span>
            <span class="n">flinkConfigKey</span><span class="o">,</span>
            <span class="n">fs</span><span class="o">,</span>
            <span class="n">appId</span><span class="o">,</span>
            <span class="k">new</span> <span class="n">Path</span><span class="o">(</span><span class="n">tmpConfigurationFile</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">()),</span>
            <span class="n">localResources</span><span class="o">,</span>
            <span class="n">homeDir</span><span class="o">,</span>
            <span class="s">&quot;&quot;</span><span class="o">);</span>
        <span class="n">envShipFileList</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">flinkConfigKey</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;=&quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">remotePathConf</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">);</span>
        <span class="n">paths</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">remotePathConf</span><span class="o">);</span>
        <span class="n">classPathBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;flink-conf.yaml&quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">File</span><span class="o">.</span><span class="na">pathSeparator</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">tmpConfigurationFile</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tmpConfigurationFile</span><span class="o">.</span><span class="na">delete</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">LOG</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;Fail to delete temporary file {}.&quot;</span><span class="o">,</span> <span class="n">tmpConfigurationFile</span><span class="o">.</span><span class="na">toPath</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">userJarInclusion</span> <span class="o">==</span> <span class="n">YarnConfigOptions</span><span class="o">.</span><span class="na">UserJarInclusion</span><span class="o">.</span><span class="na">LAST</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">userClassPath</span> <span class="o">:</span> <span class="n">userClassPaths</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">classPathBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">userClassPath</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">File</span><span class="o">.</span><span class="na">pathSeparator</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// write job graph to tmp file and add it to local resource</span>
    <span class="c1">// TODO: server use user main method to generate job graph</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">jobGraph</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">File</span> <span class="n">tmpJobGraphFile</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">tmpJobGraphFile</span> <span class="o">=</span> <span class="n">File</span><span class="o">.</span><span class="na">createTempFile</span><span class="o">(</span><span class="n">appId</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="kc">null</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">(</span><span class="n">FileOutputStream</span> <span class="n">output</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">tmpJobGraphFile</span><span class="o">);</span>
                <span class="n">ObjectOutputStream</span> <span class="n">obOutput</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">output</span><span class="o">);){</span>
                <span class="n">obOutput</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">jobGraph</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="kd">final</span> <span class="n">String</span> <span class="n">jobGraphFilename</span> <span class="o">=</span> <span class="s">&quot;job.graph&quot;</span><span class="o">;</span>
            <span class="n">flinkConfiguration</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">JOB_GRAPH_FILE_PATH</span><span class="o">,</span> <span class="n">jobGraphFilename</span><span class="o">);</span>

            <span class="n">Path</span> <span class="n">pathFromYarnURL</span> <span class="o">=</span> <span class="n">setupSingleLocalResource</span><span class="o">(</span>
                    <span class="n">jobGraphFilename</span><span class="o">,</span> <span class="n">fs</span><span class="o">,</span> <span class="n">appId</span><span class="o">,</span> <span class="k">new</span> <span class="n">Path</span><span class="o">(</span><span class="n">tmpJobGraphFile</span><span class="o">.</span><span class="na">toURI</span><span class="o">()),</span> <span class="n">localResources</span><span class="o">,</span> <span class="n">homeDir</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">);</span>
            <span class="n">paths</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pathFromYarnURL</span><span class="o">);</span>
            <span class="n">classPathBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">jobGraphFilename</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">File</span><span class="o">.</span><span class="na">pathSeparator</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">LOG</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;Add job graph to local resource fail&quot;</span><span class="o">);</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">tmpJobGraphFile</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tmpJobGraphFile</span><span class="o">.</span><span class="na">delete</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">LOG</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;Fail to delete temporary file {}.&quot;</span><span class="o">,</span> <span class="n">tmpConfigurationFile</span><span class="o">.</span><span class="na">toPath</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">final</span> <span class="n">Path</span> <span class="n">yarnFilesDir</span> <span class="o">=</span> <span class="n">getYarnFilesDir</span><span class="o">(</span><span class="n">appId</span><span class="o">);</span>
    <span class="n">FsPermission</span> <span class="n">permission</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FsPermission</span><span class="o">(</span><span class="n">FsAction</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">FsAction</span><span class="o">.</span><span class="na">NONE</span><span class="o">,</span> <span class="n">FsAction</span><span class="o">.</span><span class="na">NONE</span><span class="o">);</span>
    <span class="n">fs</span><span class="o">.</span><span class="na">setPermission</span><span class="o">(</span><span class="n">yarnFilesDir</span><span class="o">,</span> <span class="n">permission</span><span class="o">);</span> <span class="c1">// set permission for path.</span>

    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">hasLogback</span> <span class="o">=</span> <span class="n">logConfigFilePath</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">logConfigFilePath</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="n">CONFIG_FILE_LOGBACK_NAME</span><span class="o">);</span>
    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">hasLog4j</span> <span class="o">=</span> <span class="n">logConfigFilePath</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">logConfigFilePath</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="n">CONFIG_FILE_LOG4J_NAME</span><span class="o">);</span>

    <span class="c1">//5. 构造AppMaster的的container(确定container进程的入口类YarnSessionClusterEntrypoint)构造相应的Env</span>
<span class="err">★</span>    <span class="kd">final</span> <span class="n">ContainerLaunchContext</span> <span class="n">amContainer</span> <span class="o">=</span> <span class="n">setupApplicationMasterContainer</span><span class="o">(</span><span class="n">yarnClusterEntrypoint</span><span class="o">,</span> <span class="n">hasLogback</span><span class="o">,</span> <span class="n">hasLog4j</span><span class="o">,</span> <span class="n">hasKrb5</span><span class="o">,</span>
            <span class="n">clusterSpecification</span><span class="o">.</span><span class="na">getMasterMemoryMB</span><span class="o">());</span>
    <span class="n">amContainer</span><span class="o">.</span><span class="na">setLocalResources</span><span class="o">(</span><span class="n">localResources</span><span class="o">);</span>
    <span class="n">fs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

    <span class="c1">// Setup CLASSPATH and environment variables for ApplicationMaster</span>
    <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">appMasterEnv</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="c1">// set user specified app master environment variables</span>
    <span class="n">appMasterEnv</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span>
        <span class="n">BootstrapTools</span><span class="o">.</span><span class="na">getEnvironmentVariables</span><span class="o">(</span><span class="n">ResourceManagerOptions</span><span class="o">.</span><span class="na">CONTAINERIZED_MASTER_ENV_PREFIX</span><span class="o">,</span> <span class="n">configuration</span><span class="o">));</span>
    <span class="c1">// set Flink app class path</span>
    <span class="n">appMasterEnv</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">YarnConfigKeys</span><span class="o">.</span><span class="na">ENV_FLINK_CLASSPATH</span><span class="o">,</span> <span class="n">classPathBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>

    <span class="c1">// set Flink on YARN internal configuration values</span>
    <span class="n">appMasterEnv</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">YarnConfigKeys</span><span class="o">.</span><span class="na">FLINK_JAR_PATH</span><span class="o">,</span> <span class="n">remotePathJar</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="n">appMasterEnv</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">YarnConfigKeys</span><span class="o">.</span><span class="na">ENV_APP_ID</span><span class="o">,</span> <span class="n">appId</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="n">appMasterEnv</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">YarnConfigKeys</span><span class="o">.</span><span class="na">ENV_CLIENT_HOME_DIR</span><span class="o">,</span> <span class="n">homeDir</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="n">appMasterEnv</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">YarnConfigKeys</span><span class="o">.</span><span class="na">ENV_CLIENT_SHIP_FILES</span><span class="o">,</span> <span class="n">envShipFileList</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="n">appMasterEnv</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">YarnConfigKeys</span><span class="o">.</span><span class="na">ENV_ZOOKEEPER_NAMESPACE</span><span class="o">,</span> <span class="n">getZookeeperNamespace</span><span class="o">());</span>
    <span class="n">appMasterEnv</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">YarnConfigKeys</span><span class="o">.</span><span class="na">FLINK_YARN_FILES</span><span class="o">,</span> <span class="n">yarnFilesDir</span><span class="o">.</span><span class="na">toUri</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
    <span class="n">appMasterEnv</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">YarnConfigKeys</span><span class="o">.</span><span class="na">ENV_HADOOP_USER_NAME</span><span class="o">,</span> <span class="n">UserGroupInformation</span><span class="o">.</span><span class="na">getCurrentUser</span><span class="o">().</span><span class="na">getUserName</span><span class="o">());</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">remotePathKeytab</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">appMasterEnv</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">YarnConfigKeys</span><span class="o">.</span><span class="na">KEYTAB_PATH</span><span class="o">,</span> <span class="n">remotePathKeytab</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="n">String</span> <span class="n">principal</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">SecurityOptions</span><span class="o">.</span><span class="na">KERBEROS_LOGIN_PRINCIPAL</span><span class="o">);</span>
        <span class="n">appMasterEnv</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">YarnConfigKeys</span><span class="o">.</span><span class="na">KEYTAB_PRINCIPAL</span><span class="o">,</span> <span class="n">principal</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//To support Yarn Secure Integration Test Scenario</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">remoteYarnSiteXmlPath</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">appMasterEnv</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">YarnConfigKeys</span><span class="o">.</span><span class="na">ENV_YARN_SITE_XML_PATH</span><span class="o">,</span> <span class="n">remoteYarnSiteXmlPath</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">remoteKrb5Path</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">appMasterEnv</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">YarnConfigKeys</span><span class="o">.</span><span class="na">ENV_KRB5_PATH</span><span class="o">,</span> <span class="n">remoteKrb5Path</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="c1">// set classpath from YARN configuration</span>
    <span class="n">Utils</span><span class="o">.</span><span class="na">setupYarnClassPath</span><span class="o">(</span><span class="n">yarnConfiguration</span><span class="o">,</span> <span class="n">appMasterEnv</span><span class="o">);</span>
    <span class="c1">//6. 设置env</span>
<span class="err">★</span>    <span class="n">amContainer</span><span class="o">.</span><span class="na">setEnvironment</span><span class="o">(</span><span class="n">appMasterEnv</span><span class="o">);</span>

    <span class="c1">// Set up resource type requirements for ApplicationMaster</span>
    <span class="n">Resource</span> <span class="n">capability</span> <span class="o">=</span> <span class="n">Records</span><span class="o">.</span><span class="na">newRecord</span><span class="o">(</span><span class="n">Resource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">capability</span><span class="o">.</span><span class="na">setMemory</span><span class="o">(</span><span class="n">clusterSpecification</span><span class="o">.</span><span class="na">getMasterMemoryMB</span><span class="o">());</span>
    <span class="n">capability</span><span class="o">.</span><span class="na">setVirtualCores</span><span class="o">(</span><span class="n">flinkConfiguration</span><span class="o">.</span><span class="na">getInteger</span><span class="o">(</span><span class="n">YarnConfigOptions</span><span class="o">.</span><span class="na">APP_MASTER_VCORES</span><span class="o">));</span>

    <span class="kd">final</span> <span class="n">String</span> <span class="n">customApplicationName</span> <span class="o">=</span> <span class="n">customName</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">customName</span> <span class="o">:</span> <span class="n">applicationName</span><span class="o">;</span>
    <span class="n">appContext</span><span class="o">.</span><span class="na">setApplicationName</span><span class="o">(</span><span class="n">customApplicationName</span><span class="o">);</span>
    <span class="n">appContext</span><span class="o">.</span><span class="na">setApplicationType</span><span class="o">(</span><span class="n">applicationType</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">applicationType</span> <span class="o">:</span> <span class="s">&quot;Apache Flink&quot;</span><span class="o">);</span>
    <span class="n">appContext</span><span class="o">.</span><span class="na">setAMContainerSpec</span><span class="o">(</span><span class="n">amContainer</span><span class="o">);</span>
    <span class="n">appContext</span><span class="o">.</span><span class="na">setResource</span><span class="o">(</span><span class="n">capability</span><span class="o">);</span>
    <span class="c1">// Set priority for application</span>
    <span class="kt">int</span> <span class="n">priorityNum</span> <span class="o">=</span> <span class="n">flinkConfiguration</span><span class="o">.</span><span class="na">getInteger</span><span class="o">(</span><span class="n">YarnConfigOptions</span><span class="o">.</span><span class="na">APPLICATION_PRIORITY</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">priorityNum</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Priority</span> <span class="n">priority</span> <span class="o">=</span> <span class="n">Priority</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">priorityNum</span><span class="o">);</span>
        <span class="n">appContext</span><span class="o">.</span><span class="na">setPriority</span><span class="o">(</span><span class="n">priority</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">yarnQueue</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">appContext</span><span class="o">.</span><span class="na">setQueue</span><span class="o">(</span><span class="n">yarnQueue</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">setApplicationNodeLabel</span><span class="o">(</span><span class="n">appContext</span><span class="o">);</span>
    <span class="n">setApplicationTags</span><span class="o">(</span><span class="n">appContext</span><span class="o">);</span>

    <span class="c1">// add a hook to clean up in case deployment fails</span>
    <span class="n">Thread</span> <span class="n">deploymentFailureHook</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DeploymentFailureHook</span><span class="o">(</span><span class="n">yarnApplication</span><span class="o">,</span> <span class="n">yarnFilesDir</span><span class="o">);</span>
    <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">addShutdownHook</span><span class="o">(</span><span class="n">deploymentFailureHook</span><span class="o">);</span>
    <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Submitting application master &quot;</span> <span class="o">+</span> <span class="n">appId</span><span class="o">);</span>

    <span class="c1">//7. 通过yarnClient创建Application</span>
<span class="err">★</span>    <span class="n">yarnClient</span><span class="o">.</span><span class="na">submitApplication</span><span class="o">(</span><span class="n">appContext</span><span class="o">);</span>

    <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Waiting for the cluster to be allocated&quot;</span><span class="o">);</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
    <span class="n">ApplicationReport</span> <span class="n">report</span><span class="o">;</span>
    <span class="n">YarnApplicationState</span> <span class="n">lastAppState</span> <span class="o">=</span> <span class="n">YarnApplicationState</span><span class="o">.</span><span class="na">NEW</span><span class="o">;</span>

    <span class="c1">// yarnCluster部署成功之前 一直阻塞</span>
<span class="err">★</span>    <span class="n">loop</span><span class="o">:</span> <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">yarnClient</span><span class="o">.</span><span class="na">getApplicationReport</span><span class="o">(</span><span class="n">appId</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">YarnDeploymentException</span><span class="o">(</span><span class="s">&quot;Failed to deploy the cluster.&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">YarnApplicationState</span> <span class="n">appState</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="na">getYarnApplicationState</span><span class="o">();</span>
        <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Application State: {}&quot;</span><span class="o">,</span> <span class="n">appState</span><span class="o">);</span>
        <span class="c1">//跟踪ApplicationReport状态（确定是否启动成功，可能会由于资源不够，一直等待）</span>
        <span class="k">switch</span><span class="o">(</span><span class="n">appState</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="n">FAILED</span><span class="o">:</span>
            <span class="k">case</span> <span class="n">KILLED</span><span class="o">:</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">YarnDeploymentException</span><span class="o">(</span><span class="s">&quot;The YARN application unexpectedly switched to state &quot;</span>
                        <span class="o">+</span> <span class="n">appState</span> <span class="o">+</span> <span class="s">&quot; during deployment. \n&quot;</span> <span class="o">+</span>
                        <span class="s">&quot;Diagnostics from YARN: &quot;</span> <span class="o">+</span> <span class="n">report</span><span class="o">.</span><span class="na">getDiagnostics</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span> <span class="o">+</span>
                        <span class="s">&quot;If log aggregation is enabled on your cluster, use this command to further investigate the issue:\n&quot;</span> <span class="o">+</span>
                        <span class="s">&quot;yarn logs -applicationId &quot;</span> <span class="o">+</span> <span class="n">appId</span><span class="o">);</span>
                <span class="c1">//break ..</span>
            <span class="k">case</span> <span class="n">RUNNING</span><span class="o">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;YARN application has been deployed successfully.&quot;</span><span class="o">);</span>
                <span class="k">break</span> <span class="n">loop</span><span class="o">;</span>
            <span class="k">case</span> <span class="n">FINISHED</span><span class="o">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;YARN application has been finished successfully.&quot;</span><span class="o">);</span>
                <span class="k">break</span> <span class="n">loop</span><span class="o">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">appState</span> <span class="o">!=</span> <span class="n">lastAppState</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Deploying cluster, current state &quot;</span> <span class="o">+</span> <span class="n">appState</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">startTime</span> <span class="o">&gt;</span> <span class="mi">60000</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Deployment took more than 60 seconds. Please check if the requested resources are available in the YARN cluster&quot;</span><span class="o">);</span>
                <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">lastAppState</span> <span class="o">=</span> <span class="n">appState</span><span class="o">;</span>
        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">250</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// since deployment was successful, remove the hook</span>
    <span class="n">ShutdownHookUtil</span><span class="o">.</span><span class="na">removeShutdownHook</span><span class="o">(</span><span class="n">deploymentFailureHook</span><span class="o">,</span> <span class="n">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">LOG</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">report</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
AbstractYarnClusterDescriptor#startAppMaster启动AppMaster</p>
<h6 id="deployinternal">上述deployInternal()方法主要做了如下几件事：<a class="headerlink" href="#deployinternal" title="Permanent link"></a></h6>
<ol>
<li>初始化文件系统（HDFS）、 创建appContext 提交启动yarn集群的上下文ApplicationSubmissionContext</li>
<li>将log4j、logback、flink-conf.yaml、jar包上传至HDFS</li>
<li>生成ApplicationID</li>
<li>上传和注册ship-only files</li>
<li>构造AppMaster的的container(确定container进程的入口类YarnSessionClusterEntrypoint)构造相应的Env</li>
<li>设置env</li>
<li>通过yarnClient创建Application：yarnClient.submitApplication(appContext);</li>
<li>通过while循环实现yarnCluster部署成功之前 一直阻塞</li>
</ol>
<p>接下来就是创建与集群交互的ClusterClient(创建基于Netty的RestClient)</p>
<p>通过ClusterClient获取到appId信息并写入本地临时文件
return new RestClusterClient&lt;&gt;(flinkConfiguration, report.getApplicationId());
<div class="codehilite"><pre><span class="n">RestClusterClient</span><span class="o">.</span><span class="na">java</span>
<span class="kd">private</span> <span class="nf">RestClusterClient</span><span class="o">(</span> <span class="n">Configuration</span> <span class="n">configuration</span><span class="o">,</span>
    <span class="nd">@Nullable</span> <span class="n">RestClient</span> <span class="n">restClient</span><span class="o">,</span> <span class="n">T</span> <span class="n">clusterId</span><span class="o">,</span> <span class="n">WaitStrategy</span> <span class="n">waitStrategy</span><span class="o">,</span>
    <span class="n">ClientHighAvailabilityServices</span> <span class="n">clientHAServices</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">configuration</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">restClusterClientConfiguration</span> <span class="o">=</span> <span class="n">RestClusterClientConfiguration</span><span class="o">.</span><span class="na">fromConfiguration</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">restClient</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">restClient</span> <span class="o">=</span> <span class="n">restClient</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="c1">//创建基于Netty的RestClient</span>
<span class="err">★</span>   <span class="k">this</span><span class="o">.</span><span class="na">restClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RestClient</span><span class="o">(</span><span class="n">restClusterClientConfiguration</span><span class="o">.</span><span class="na">getRestClientConfiguration</span><span class="o">(),</span> <span class="n">executorService</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">this</span><span class="o">.</span><span class="na">waitStrategy</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="o">(</span><span class="n">waitStrategy</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">clusterId</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="o">(</span><span class="n">clusterId</span><span class="o">);</span>
<span class="c1">// 判断客户端的HAService是否为空，为空抛出异常</span>
<span class="err">★</span>    <span class="k">this</span><span class="o">.</span><span class="na">clientHAServices</span> <span class="o">=</span> <span class="n">checkNotNull</span><span class="o">(</span><span class="n">clientHAServices</span><span class="o">);</span>
<span class="c1">//Get the leader retriever for the cluster&#39;s rest endpoint.</span>
<span class="n">①</span>    <span class="k">this</span><span class="o">.</span><span class="na">webMonitorRetrievalService</span> <span class="o">=</span> <span class="n">clientHAServices</span><span class="o">.</span><span class="na">getClusterRestEndpointLeaderRetriever</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">retryExecutorService</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newSingleThreadScheduledExecutor</span><span class="o">(</span><span class="k">new</span> <span class="n">ExecutorThreadFactory</span><span class="o">(</span><span class="s">&quot;Flink-RestClusterClient-Retry&quot;</span><span class="o">));</span>
<span class="n">②</span>    <span class="nf">startLeaderRetrievers</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
①关于获取client retriever的逻辑如下：
<div class="codehilite"><pre><span class="n">ZooKeeperClientHAServices</span><span class="o">.</span><span class="na">java</span>
<span class="nd">@Override</span>
<span class="c1">//REST_SERVER_LEADER_PATH = &quot;/rest_server_lock&quot;</span>
<span class="kd">public</span> <span class="n">LeaderRetrievalService</span> <span class="nf">getClusterRestEndpointLeaderRetriever</span><span class="o">()</span> <span class="o">{</span>
<span class="err">★</span>    <span class="k">return</span> <span class="n">ZooKeeperUtils</span><span class="o">.</span><span class="na">createLeaderRetrievalService</span><span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="n">configuration</span><span class="o">,</span> <span class="n">REST_SERVER_LEADER_PATH</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<div class="codehilite"><pre><span class="n">ZooKeeperUtils</span><span class="o">.</span><span class="na">java</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">ZooKeeperLeaderRetrievalService</span> <span class="nf">createLeaderRetrievalService</span><span class="o">(</span>
    <span class="kd">final</span> <span class="n">CuratorFramework</span> <span class="n">client</span><span class="o">,</span>
    <span class="kd">final</span> <span class="n">Configuration</span> <span class="n">configuration</span><span class="o">,</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">pathSuffix</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//如果在配置文件中不设置HA_ZOOKEEPER_LEADER_PATH 默认为/leader</span>
    <span class="c1">//leaderPath = /leader/rest_server_lock</span>
    <span class="n">String</span> <span class="n">leaderPath</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span>
        <span class="n">HighAvailabilityOptions</span><span class="o">.</span><span class="na">HA_ZOOKEEPER_LEADER_PATH</span><span class="o">)</span> <span class="o">+</span> <span class="n">pathSuffix</span><span class="o">;</span>
<span class="err">★</span>    <span class="k">return</span> <span class="k">new</span> <span class="n">ZooKeeperLeaderRetrievalService</span><span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="n">leaderPath</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<div class="codehilite"><pre><span class="cm">/**</span>
<span class="cm"> * Creates a leader retrieval service which uses ZooKeeper to retrieve the leader information.</span>
<span class="cm"> * @param client ：连接到 ZooKeeper quorum 的curator客户端</span>
<span class="cm"> * @param retrievalPath： 代表leader information的路径</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="nf">ZooKeeperLeaderRetrievalService</span><span class="o">(</span><span class="n">CuratorFramework</span> <span class="n">client</span><span class="o">,</span> <span class="n">String</span> <span class="n">retrievalPath</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">client</span> <span class="o">=</span> <span class="n">Preconditions</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="s">&quot;CuratorFramework client&quot;</span><span class="o">);</span>
<span class="err">★</span>    <span class="k">this</span><span class="o">.</span><span class="na">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NodeCache</span><span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="n">retrievalPath</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">retrievalPath</span> <span class="o">=</span> <span class="n">Preconditions</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">retrievalPath</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">leaderListener</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">lastLeaderAddress</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">lastLeaderSessionID</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
② 启动leader retrieval服务，并对新的leader节点进行监听(Starts the leader retrieval service with the given listener to listen for new leaders. This method can only be called once.)
<div class="codehilite"><pre><span class="n">RestClusterClient</span><span class="o">.</span><span class="na">java</span>
<span class="kd">private</span> <span class="kt">void</span> <span class="nf">startLeaderRetrievers</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">webMonitorRetrievalService</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">webMonitorLeaderRetriever</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<div class="codehilite"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="n">LeaderRetrievalListener</span> <span class="n">listener</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">Preconditions</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">listener</span><span class="o">,</span> <span class="s">&quot;Listener must not be null.&quot;</span><span class="o">);</span>
    <span class="n">Preconditions</span><span class="o">.</span><span class="na">checkState</span><span class="o">(</span><span class="n">leaderListener</span> <span class="o">==</span> <span class="kc">null</span><span class="o">,</span> <span class="s">&quot;ZooKeeperLeaderRetrievalService can &quot;</span> <span class="o">+</span> <span class="s">&quot;only be started once.&quot;</span><span class="o">);</span>
    <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Starting ZooKeeperLeaderRetrievalService {}.&quot;</span><span class="o">,</span> <span class="n">retrievalPath</span><span class="o">);</span>

    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">leaderListener</span> <span class="o">=</span> <span class="n">listener</span><span class="o">;</span>
        <span class="n">client</span><span class="o">.</span><span class="na">getUnhandledErrorListenable</span><span class="o">().</span><span class="na">addListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="c1">//启动监听节点的变化(主备切换)</span>
        <span class="n">cache</span><span class="o">.</span><span class="na">getListenable</span><span class="o">().</span><span class="na">addListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="n">cache</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">client</span><span class="o">.</span><span class="na">getConnectionStateListenable</span><span class="o">().</span><span class="na">addListener</span><span class="o">(</span><span class="n">connectionStateListener</span><span class="o">);</span>
        <span class="n">running</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
经过上述步骤，整个客户端的启动流程就结束了，下面分析yarn拉起Session集群的流程，入口类是申请Container时指定为YarnSessionClusterEntrypoint。
<div class="codehilite"><pre><span class="c1">//构造AppMaster的的container(确定container进程的入口类YarnSessionClusterEntrypoint)构造相应的Env</span>
<span class="kd">final</span> <span class="n">ContainerLaunchContext</span> <span class="n">amContainer</span> <span class="o">=</span> <span class="n">setupApplicationMasterContainer</span><span class="o">(</span>
<span class="err">★</span>        <span class="n">yarnClusterEntrypoint</span><span class="o">,</span> <span class="n">hasLogback</span><span class="o">,</span> <span class="n">hasLog4j</span><span class="o">,</span> <span class="n">hasKrb5</span><span class="o">,</span>
        <span class="n">clusterSpecification</span><span class="o">.</span><span class="na">getMasterMemoryMB</span><span class="o">());</span>
</pre></div></p>
<h6 id="_1">客户端流程总结<a class="headerlink" href="#_1" title="Permanent link"></a></h6>
<p>画图总结：</p>
<p><img alt="" src="/Users/liaomengjie/workspace/learngit/leetcode/todo/Flink/YarnSession%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%B0%83%E8%B5%B7%E6%B5%81%E7%A8%8B.png" /></p>
<h5 id="322">3.2.2、远端流程<a class="headerlink" href="#322" title="Permanent link"></a></h5>
<p>远端宿主在Container中的集群入口为YarnSessionClusterEntrypoint#main</p>
<p>Yarn Session集群的Entry point为YarnSessionClusterEntrypoint#main
<div class="codehilite"><pre><span class="n">point为YarnSessionClusterEntrypoint</span><span class="o">.</span><span class="na">java</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// startup checks and logging</span>
    <span class="n">EnvironmentInformation</span><span class="o">.</span><span class="na">logEnvironmentInfo</span><span class="o">(</span><span class="n">LOG</span><span class="o">,</span> <span class="n">YarnSessionClusterEntrypoint</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="n">args</span><span class="o">);</span>
    <span class="n">SignalHandler</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">LOG</span><span class="o">);</span>
    <span class="n">JvmShutdownSafeguard</span><span class="o">.</span><span class="na">installAsShutdownHook</span><span class="o">(</span><span class="n">LOG</span><span class="o">);</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">env</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getenv</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">workingDirectory</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ApplicationConstants</span><span class="o">.</span><span class="na">Environment</span><span class="o">.</span><span class="na">PWD</span><span class="o">.</span><span class="na">key</span><span class="o">());</span>
    <span class="n">Preconditions</span><span class="o">.</span><span class="na">checkArgument</span><span class="o">(</span>
        <span class="n">workingDirectory</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">,</span><span class="s">&quot;Working directory variable (%s) not set&quot;</span><span class="o">,</span>
        <span class="n">ApplicationConstants</span><span class="o">.</span><span class="na">Environment</span><span class="o">.</span><span class="na">PWD</span><span class="o">.</span><span class="na">key</span><span class="o">());</span>
    <span class="n">YarnEntrypointUtils</span><span class="o">.</span><span class="na">logYarnEnvironmentInformation</span><span class="o">(</span><span class="n">env</span><span class="o">,</span> <span class="n">LOG</span><span class="o">);</span>
    <span class="n">Configuration</span> <span class="n">configuration</span> <span class="o">=</span> <span class="n">YarnEntrypointUtils</span><span class="o">.</span><span class="na">loadConfiguration</span><span class="o">(</span><span class="n">workingDirectory</span><span class="o">,</span> <span class="n">env</span><span class="o">);</span>

    <span class="n">YarnSessionClusterEntrypoint</span> <span class="n">yarnSessionClusterEntrypoint</span> <span class="o">=</span> <span class="k">new</span> <span class="n">YarnSessionClusterEntrypoint</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
    <span class="c1">//启动集群</span>
<span class="err">★</span>   <span class="n">ClusterEntrypoint</span><span class="o">.</span><span class="na">runClusterEntrypoint</span><span class="o">(</span><span class="n">yarnSessionClusterEntrypoint</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
ClusterEntrypoint #runClusterEntrypoint -&gt; ClusterEntrypoint#startCluster-&gt;ClusterEntrypoint#runCluster启动集群
<div class="codehilite"><pre><span class="n">ClusterEntrypoint</span><span class="o">.</span><span class="na">java</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">runClusterEntrypoint</span><span class="o">(</span><span class="n">ClusterEntrypoint</span> <span class="n">clusterEntrypoint</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">clusterEntrypointName</span> <span class="o">=</span> <span class="n">clusterEntrypoint</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getSimpleName</span><span class="o">();</span>
    <span class="c1">//启动Flink集群</span>
<span class="err">★</span>    <span class="n">clusterEntrypoint</span><span class="o">.</span><span class="na">startCluster</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">startCluster</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ClusterEntrypointException</span> <span class="o">{</span>
    <span class="n">configureFileSystems</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
    <span class="n">SecurityContext</span> <span class="n">securityContext</span> <span class="o">=</span> <span class="n">installSecurityContext</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
    <span class="n">securityContext</span><span class="o">.</span><span class="na">runSecured</span><span class="o">((</span><span class="n">Callable</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;)</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="c1">//通过回调启动集群runCluster();</span>
<span class="err">★</span>       <span class="n">runCluster</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
        <span class="c1">//至此经过上述步骤就完成了集群的启动</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></div></p>
<h6 id="_2">经过上述步骤开始集群的启动：<a class="headerlink" href="#_2" title="Permanent link"></a></h6>
<p><div class="codehilite"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">runCluster</span><span class="o">(</span><span class="n">Configuration</span> <span class="n">configuration</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//1. 首先会初始化相关服务(这里会涉及到一系列的服务)</span>
        <span class="n">initializeServices</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
        <span class="c1">// write host information into configuration</span>
        <span class="n">configuration</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">JobManagerOptions</span><span class="o">.</span><span class="na">ADDRESS</span><span class="o">,</span> <span class="n">commonRpcService</span><span class="o">.</span><span class="na">getAddress</span><span class="o">());</span>
        <span class="n">configuration</span><span class="o">.</span><span class="na">setInteger</span><span class="o">(</span><span class="n">JobManagerOptions</span><span class="o">.</span><span class="na">PORT</span><span class="o">,</span> <span class="n">commonRpcService</span><span class="o">.</span><span class="na">getPort</span><span class="o">());</span>
        <span class="c1">//2. 创建DispatcherResourceManagerFactory</span>
        <span class="kd">final</span> <span class="n">DispatcherResourceManagerComponentFactory</span> <span class="n">dispatcherResourceManagerComponentFactory</span> <span class="o">=</span> <span class="n">createDispatcherResourceManagerComponentFactory</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>

        <span class="c1">//3. 创建DispatcherResourceManagerComponent这个对象(用于启动Dispatcher、ResourceManager、WebMonitorEndpoint)</span>
        <span class="n">clusterComponent</span> <span class="o">=</span> <span class="n">dispatcherResourceManagerComponentFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span>
            <span class="n">configuration</span><span class="o">,</span> <span class="n">ioExecutor</span><span class="o">,</span> <span class="n">commonRpcService</span><span class="o">,</span> <span class="n">haServices</span><span class="o">,</span> <span class="n">blobServer</span><span class="o">,</span> <span class="n">heartbeatServices</span><span class="o">,</span> <span class="n">metricRegistry</span><span class="o">,</span> <span class="n">archivedExecutionGraphStore</span><span class="o">,</span>
            <span class="k">new</span> <span class="n">RpcMetricQueryServiceRetriever</span><span class="o">(</span><span class="n">metricRegistry</span><span class="o">.</span><span class="na">getMetricQueryServiceRpcService</span><span class="o">()),</span> <span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
集群启动时会初始化一些Services，还会创建一些组件：创建DispatcherResourceManagerComponentFactory(SessionDispatcherResourceManagerCompontFactory), 并使用Factory创建DispatcherResourceManagerComponent（用于启动Dispatcher、ResourceManager、WebMonitorEndpoint）</p>
<p>初始化Services逻辑具体如下：
<div class="codehilite"><pre><span class="n">ClusterEntrypoint</span><span class="o">.</span><span class="na">java</span>
<span class="c1">// 启动集群时候初始化的相关的服务</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initializeServices</span><span class="o">(</span><span class="n">Configuration</span> <span class="n">configuration</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">String</span> <span class="n">bindAddress</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="n">JobManagerOptions</span><span class="o">.</span><span class="na">ADDRESS</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">String</span> <span class="n">portRange</span> <span class="o">=</span> <span class="n">getRPCPortRange</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
        <span class="c1">// 1.创建RPCService（AkkaRpcService）</span>
        <span class="n">commonRpcService</span> <span class="o">=</span> <span class="n">createRpcService</span><span class="o">(</span><span class="n">configuration</span><span class="o">,</span> <span class="n">bindAddress</span><span class="o">,</span> <span class="n">portRange</span><span class="o">);</span>
        <span class="c1">// update the configuration used to create the high availability services</span>
        <span class="c1">//根据当前创建的RPC服务信息在configuration中增加配置信息（之前设置的端口可能是一个range）</span>
        <span class="n">configuration</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="n">JobManagerOptions</span><span class="o">.</span><span class="na">ADDRESS</span><span class="o">,</span> <span class="n">commonRpcService</span><span class="o">.</span><span class="na">getAddress</span><span class="o">());</span>
        <span class="n">configuration</span><span class="o">.</span><span class="na">setInteger</span><span class="o">(</span><span class="n">JobManagerOptions</span><span class="o">.</span><span class="na">PORT</span><span class="o">,</span> <span class="n">commonRpcService</span><span class="o">.</span><span class="na">getPort</span><span class="o">());</span>

        <span class="c1">// 2.创建用于IO的线程池</span>
        <span class="n">ioExecutor</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span>
            <span class="n">Hardware</span><span class="o">.</span><span class="na">getNumberCPUCores</span><span class="o">(),</span>
            <span class="k">new</span> <span class="n">ExecutorThreadFactory</span><span class="o">(</span><span class="s">&quot;cluster-io&quot;</span><span class="o">));</span>
        <span class="c1">// 3.创建HA Service（跟用户配置有关，可以是NONE、ZooKeeper也可以自定义的类）</span>
        <span class="n">haServices</span> <span class="o">=</span> <span class="n">createHaServices</span><span class="o">(</span><span class="n">configuration</span><span class="o">,</span> <span class="n">ioExecutor</span><span class="o">);</span>
        <span class="c1">// 4.初始化Blob Server</span>
      <span class="n">blobServer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BlobServer</span><span class="o">(</span><span class="n">configuration</span><span class="o">,</span> <span class="n">haServices</span><span class="o">.</span><span class="na">createBlobStore</span><span class="o">());</span>
        <span class="n">blobServer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="c1">// 5.启动heartbeat service</span>
        <span class="n">heartbeatServices</span> <span class="o">=</span> <span class="n">createHeartbeatServices</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
        <span class="c1">// 6.创建了一个Flink内部的metrics rpc service</span>
        <span class="n">metricRegistry</span> <span class="o">=</span> <span class="n">createMetricRegistry</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
        <span class="c1">// 7.启动MetricQuerService</span>
        <span class="kd">final</span> <span class="n">RpcService</span> <span class="n">metricQueryServiceRpcService</span> <span class="o">=</span> <span class="n">MetricUtils</span><span class="o">.</span><span class="na">startMetricsRpcService</span><span class="o">(</span><span class="n">configuration</span><span class="o">,</span> <span class="n">bindAddress</span><span class="o">);</span>
        <span class="n">metricRegistry</span><span class="o">.</span><span class="na">startQueryService</span><span class="o">(</span><span class="n">metricQueryServiceRpcService</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>

        <span class="kd">final</span> <span class="n">String</span> <span class="n">hostname</span> <span class="o">=</span> <span class="n">RpcUtils</span><span class="o">.</span><span class="na">getHostname</span><span class="o">(</span><span class="n">commonRpcService</span><span class="o">);</span>

        <span class="n">processMetricGroup</span> <span class="o">=</span> <span class="n">MetricUtils</span><span class="o">.</span><span class="na">instantiateProcessMetricGroup</span><span class="o">(</span>
            <span class="n">metricRegistry</span><span class="o">,</span>
            <span class="n">hostname</span><span class="o">,</span>
            <span class="n">ConfigurationUtils</span><span class="o">.</span><span class="na">getSystemResourceMetricsProbingInterval</span><span class="o">(</span><span class="n">configuration</span><span class="o">));</span>
        <span class="c1">// 8.创建了一个ArchiveExectionGraphStore对象，用于存储用户作业的物理graph</span>
        <span class="n">archivedExecutionGraphStore</span> <span class="o">=</span> <span class="n">createSerializableExecutionGraphStore</span><span class="o">(</span><span class="n">configuration</span><span class="o">,</span> <span class="n">commonRpcService</span><span class="o">.</span><span class="na">getScheduledExecutor</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
上述初始化服务：创建RPCService(akkaRpcService)、创建HAService、创建并启动BlobService、创建HeartbeatServices、创建指标服务并启动、创建本地存储ExecutionGraph的stroe</p>
<p>使用前面在initializeServices中已经初始化的services,创建DispatcherResourceManagerComponent逻辑如下：
<div class="codehilite"><pre><span class="n">DefaultDispatcherResourceManagerComponentFactory</span><span class="o">.</span><span class="na">java</span>
<span class="c1">//创建DispatcherResourceManagerComponent对象</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">DispatcherResourceManagerComponent</span> <span class="nf">create</span><span class="o">(</span>
        <span class="n">Configuration</span> <span class="n">configuration</span><span class="o">,</span> <span class="n">Executor</span> <span class="n">ioExecutor</span><span class="o">,</span>
        <span class="n">RpcService</span> <span class="n">rpcService</span><span class="o">,</span> <span class="n">HighAvailabilityServices</span> <span class="n">highAvailabilityServices</span><span class="o">,</span> <span class="n">BlobServer</span> <span class="n">blobServer</span><span class="o">,</span>
        <span class="n">HeartbeatServices</span> <span class="n">heartbeatServices</span><span class="o">,</span> <span class="n">MetricRegistry</span> <span class="n">metricRegistry</span><span class="o">,</span>
        <span class="n">ArchivedExecutionGraphStore</span> <span class="n">archivedExecutionGraphStore</span><span class="o">,</span>
        <span class="n">MetricQueryServiceRetriever</span> <span class="n">metricQueryServiceRetriever</span><span class="o">,</span>
        <span class="n">FatalErrorHandler</span> <span class="n">fatalErrorHandler</span><span class="o">){</span>

<span class="c1">//---创建DispatcherResourceManagerComponent对象需要的service组件--</span>
    <span class="c1">//dispatcher的Leader retrieval服务</span>
    <span class="n">LeaderRetrievalService</span> <span class="n">dispatcherLeaderRetrievalService</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="c1">//resourceManager retrieval服务</span>
    <span class="n">LeaderRetrievalService</span> <span class="n">resourceManagerRetrievalService</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="c1">//它主要使用web前端的rest接口调用、Zk listener for leader retrieval</span>
    <span class="n">WebMonitorEndpoint</span><span class="o">&lt;?&gt;</span> <span class="n">webMonitorEndpoint</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="c1">//resourceManager组件</span>
    <span class="n">ResourceManager</span><span class="o">&lt;?&gt;</span> <span class="n">resourceManager</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">ResourceManagerMetricGroup</span> <span class="n">resourceManagerMetricGroup</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="c1">//dispatcher</span>
    <span class="n">DispatcherRunner</span> <span class="n">dispatcherRunner</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="c1">//用于Dispatcher leader选举 即在ZK在创建/dispatcher_lock节点</span>
    <span class="n">dispatcherLeaderRetrievalService</span> <span class="o">=</span> <span class="n">highAvailabilityServices</span><span class="o">.</span><span class="na">getDispatcherLeaderRetriever</span><span class="o">();</span>
    <span class="c1">//用于Resource Manager leader 选举（对于使用ZK的HA模式来说，与上面的区别是使用的路径不同）/resource_manager_lock节点</span>
    <span class="n">resourceManagerRetrievalService</span> <span class="o">=</span> <span class="n">highAvailabilityServices</span><span class="o">.</span><span class="na">getResourceManagerLeaderRetriever</span><span class="o">();</span>

    <span class="c1">//创建DispatcherGateway的Retriever</span>
    <span class="kd">final</span> <span class="n">LeaderGatewayRetriever</span><span class="o">&lt;</span><span class="n">DispatcherGateway</span><span class="o">&gt;</span> <span class="n">dispatcherGatewayRetriever</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RpcGatewayRetriever</span><span class="o">&lt;&gt;(</span>
        <span class="n">rpcService</span><span class="o">,</span> <span class="n">DispatcherGateway</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">DispatcherId</span><span class="o">::</span><span class="n">fromUuid</span><span class="o">,</span>
        <span class="mi">10</span><span class="o">,</span> <span class="n">Time</span><span class="o">.</span><span class="na">milliseconds</span><span class="o">(</span><span class="mi">50L</span><span class="o">));</span>
    <span class="c1">// 创建ResoureManagerGateway的Retriever</span>
    <span class="kd">final</span> <span class="n">LeaderGatewayRetriever</span><span class="o">&lt;</span><span class="n">ResourceManagerGateway</span><span class="o">&gt;</span> <span class="n">resourceManagerGatewayRetriever</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RpcGatewayRetriever</span><span class="o">&lt;&gt;(</span>
        <span class="n">rpcService</span><span class="o">,</span> <span class="n">ResourceManagerGateway</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">ResourceManagerId</span><span class="o">::</span><span class="n">fromUuid</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="n">Time</span><span class="o">.</span><span class="na">milliseconds</span><span class="o">(</span><span class="mi">50L</span><span class="o">));</span>
    <span class="c1">//它主要使用web前端的rest接口调用</span>
    <span class="kd">final</span> <span class="n">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">WebMonitorEndpoint</span><span class="o">.</span><span class="na">createExecutorService</span><span class="o">(</span>
        <span class="n">configuration</span><span class="o">.</span><span class="na">getInteger</span><span class="o">(</span><span class="n">RestOptions</span><span class="o">.</span><span class="na">SERVER_NUM_THREADS</span><span class="o">),</span>
        <span class="n">configuration</span><span class="o">.</span><span class="na">getInteger</span><span class="o">(</span><span class="n">RestOptions</span><span class="o">.</span><span class="na">SERVER_THREAD_PRIORITY</span><span class="o">),</span>
        <span class="s">&quot;DispatcherRestEndpoint&quot;</span><span class="o">);</span>

    <span class="kd">final</span> <span class="kt">long</span> <span class="n">updateInterval</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="n">MetricOptions</span><span class="o">.</span><span class="na">METRIC_FETCHER_UPDATE_INTERVAL</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">MetricFetcher</span> <span class="n">metricFetcher</span> <span class="o">=</span> <span class="n">updateInterval</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="o">?</span> <span class="n">VoidMetricFetcher</span><span class="o">.</span><span class="na">INSTANCE</span>
        <span class="o">:</span> <span class="n">MetricFetcherImpl</span><span class="o">.</span><span class="na">fromConfiguration</span><span class="o">(</span>
            <span class="n">configuration</span><span class="o">,</span> <span class="n">metricQueryServiceRetriever</span><span class="o">,</span>
            <span class="n">dispatcherGatewayRetriever</span><span class="o">,</span>  <span class="n">executor</span><span class="o">);</span>

    <span class="c1">//【重点】创建WebMonitorEndpoint，并启动</span>
    <span class="c1">// 在standalone模式下，这里创建的是DispatcherRestEndpoint对象</span>
    <span class="n">webMonitorEndpoint</span> <span class="o">=</span> <span class="n">restEndpointFactory</span><span class="o">.</span><span class="na">createRestEndpoint</span><span class="o">(</span>
        <span class="n">configuration</span><span class="o">,</span> <span class="n">dispatcherGatewayRetriever</span><span class="o">,</span>
        <span class="n">resourceManagerGatewayRetriever</span><span class="o">,</span> <span class="n">blobServer</span><span class="o">,</span> <span class="n">executor</span><span class="o">,</span>
        <span class="n">metricFetcher</span><span class="o">,</span> <span class="n">highAvailabilityServices</span><span class="o">.</span><span class="na">getClusterRestEndpointLeaderElectionService</span><span class="o">(),</span>
        <span class="n">fatalErrorHandler</span><span class="o">);</span>

    <span class="c1">//启动DispatcherRestEndpoint</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Starting Dispatcher REST endpoint.&quot;</span><span class="o">);</span>
    <span class="n">webMonitorEndpoint</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

    <span class="kd">final</span> <span class="n">String</span> <span class="n">hostname</span> <span class="o">=</span> <span class="n">RpcUtils</span><span class="o">.</span><span class="na">getHostname</span><span class="o">(</span><span class="n">rpcService</span><span class="o">);</span>
    <span class="c1">//创建ResourceManager的指标组</span>
    <span class="n">resourceManagerMetricGroup</span> <span class="o">=</span> <span class="n">ResourceManagerMetricGroup</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">metricRegistry</span><span class="o">,</span> <span class="n">hostname</span><span class="o">);</span>

    <span class="c1">//【重点】创建resourceManager并启动(Standalone/session模式，这里创建的是StandaloneResourceManager对象)</span>
<span class="err">★</span>        <span class="n">resourceManager</span> <span class="o">=</span> <span class="n">resourceManagerFactory</span><span class="o">.</span><span class="na">createResourceManager</span><span class="o">(</span>
        <span class="n">configuration</span><span class="o">,</span> <span class="n">ResourceID</span><span class="o">.</span><span class="na">generate</span><span class="o">(),</span> <span class="n">rpcService</span><span class="o">,</span>
        <span class="n">highAvailabilityServices</span><span class="o">,</span> <span class="n">heartbeatServices</span><span class="o">,</span> <span class="n">fatalErrorHandler</span><span class="o">,</span>
        <span class="k">new</span> <span class="n">ClusterInformation</span><span class="o">(</span><span class="n">hostname</span><span class="o">,</span> <span class="n">blobServer</span><span class="o">.</span><span class="na">getPort</span><span class="o">()),</span>
        <span class="n">webMonitorEndpoint</span><span class="o">.</span><span class="na">getRestBaseUrl</span><span class="o">(),</span> <span class="n">resourceManagerMetricGroup</span><span class="o">);</span>

    <span class="kd">final</span> <span class="n">HistoryServerArchivist</span> <span class="n">historyServerArchivist</span> <span class="o">=</span> <span class="n">HistoryServerArchivist</span><span class="o">.</span><span class="na">createHistoryServerArchivist</span><span class="o">(</span><span class="n">configuration</span><span class="o">,</span> <span class="n">webMonitorEndpoint</span><span class="o">);</span>

    <span class="c1">//创建dispatcher对象</span>
<span class="err">★</span>        <span class="kd">final</span> <span class="n">PartialDispatcherServices</span> <span class="n">partialDispatcherServices</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PartialDispatcherServices</span><span class="o">(</span> <span class="n">configuration</span><span class="o">,</span> <span class="n">highAvailabilityServices</span><span class="o">,</span>
        <span class="n">resourceManagerGatewayRetriever</span><span class="o">,</span> <span class="n">blobServer</span><span class="o">,</span> <span class="n">heartbeatServices</span><span class="o">,</span>
        <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">MetricUtils</span><span class="o">.</span><span class="na">instantiateJobManagerMetricGroup</span><span class="o">(</span><span class="n">metricRegistry</span><span class="o">,</span> <span class="n">hostname</span><span class="o">),</span>
        <span class="n">archivedExecutionGraphStore</span><span class="o">,</span> <span class="n">fatalErrorHandler</span><span class="o">,</span> <span class="n">historyServerArchivist</span><span class="o">,</span>
        <span class="n">metricRegistry</span><span class="o">.</span><span class="na">getMetricQueryServiceGatewayRpcAddress</span><span class="o">());</span>

    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Starting Dispatcher.&quot;</span><span class="o">);</span>
    <span class="c1">//启动Dispatcher并进行ZK选举</span>
    <span class="n">dispatcherRunner</span> <span class="o">=</span> <span class="n">dispatcherRunnerFactory</span><span class="o">.</span><span class="na">createDispatcherRunner</span><span class="o">(</span>
        <span class="n">highAvailabilityServices</span><span class="o">.</span><span class="na">getDispatcherLeaderElectionService</span><span class="o">(),</span>
        <span class="n">fatalErrorHandler</span><span class="o">,</span>
        <span class="k">new</span> <span class="n">HaServicesJobGraphStoreFactory</span><span class="o">(</span><span class="n">highAvailabilityServices</span><span class="o">),</span>
        <span class="n">ioExecutor</span><span class="o">,</span> <span class="n">rpcService</span><span class="o">,</span> <span class="n">partialDispatcherServices</span><span class="o">);</span>

    <span class="c1">// 启动ResourceManager并进行ZK选举</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Starting ResourceManager.&quot;</span><span class="o">);</span>
    <span class="n">resourceManager</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

    <span class="c1">//使用resourceManagerGatewayRetriever去监听zk的/resource_manager_lock节点</span>
    <span class="n">resourceManagerRetrievalService</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">resourceManagerGatewayRetriever</span><span class="o">);</span>
    <span class="c1">//使用dispatcherGateWayRetriever去监听zk的/dispatcher_lock节点</span>
    <span class="n">dispatcherLeaderRetrievalService</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">dispatcherGatewayRetriever</span><span class="o">);</span>

    <span class="c1">//返回sessionDidpatcherResourceManagerComponent</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">DispatcherResourceManagerComponent</span><span class="o">(</span>
        <span class="n">dispatcherRunner</span><span class="o">,</span><span class="n">resourceManager</span><span class="o">,</span>
        <span class="n">dispatcherLeaderRetrievalService</span><span class="o">,</span>
        <span class="n">resourceManagerRetrievalService</span><span class="o">,</span><span class="n">webMonitorEndpoint</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
上述代码实现：</p>
<ol>
<li>在zk中创建/dispatcher_lock节点、/resource_manager_lock节点</li>
<li>创建dispatcherGatewayRetriever、resourManagerGatewayRetrieval( rpc gateway接口)</li>
<li>创建dispatcher、resourceManager并启动</li>
</ol>
<h5 id="_3">服务端总结<a class="headerlink" href="#_3" title="Permanent link"></a></h5>
<p><img alt="" src="" /></p>
<h4 id="33">3.3、启动作业<a class="headerlink" href="#33" title="Permanent link"></a></h4>
<p>当启动集群后，即可使用./flink run -c mainClass /path/to/usr/jar向集群提交任务</p>
<h4 id="34-">3.4、启动作业流程分析&ndash;客户端<a class="headerlink" href="#34-" title="Permanent link"></a></h4>
<p><strong><em>----开始：yarn Session-Cluster 与 yarn per-job-Cluster模式公共部分----</em></strong>
flink.sh&ndash;&gt;程序入口CliFrontend#main
<div class="codehilite"><pre><span class="n">CliFrontend</span><span class="o">.</span><span class="na">java</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">EnvironmentInformation</span><span class="o">.</span><span class="na">logEnvironmentInfo</span><span class="o">(</span><span class="n">LOG</span><span class="o">,</span> <span class="s">&quot;Command Line Client&quot;</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="c1">// 1. find the configuration directory</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">configurationDirectory</span> <span class="o">=</span> <span class="n">getConfigurationDirectoryFromEnv</span><span class="o">();</span>
    <span class="c1">// 2. load the global configuration</span>
    <span class="kd">final</span> <span class="n">Configuration</span> <span class="n">configuration</span> <span class="o">=</span> <span class="n">GlobalConfiguration</span><span class="o">.</span><span class="na">loadConfiguration</span><span class="o">(</span><span class="n">configurationDirectory</span><span class="o">);</span>
    <span class="c1">// 3. load the custom command lines</span>
    <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">CustomCommandLine</span><span class="o">&gt;</span> <span class="n">customCommandLines</span> <span class="o">=</span> <span class="n">loadCustomCommandLines</span><span class="o">(</span>
        <span class="n">configuration</span><span class="o">,</span>
        <span class="n">configurationDirectory</span><span class="o">);</span>

    <span class="kd">final</span> <span class="n">CliFrontend</span> <span class="n">cli</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CliFrontend</span><span class="o">(</span>
        <span class="n">configuration</span><span class="o">,</span>
        <span class="n">customCommandLines</span><span class="o">);</span>

    <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">install</span><span class="o">(</span><span class="k">new</span> <span class="n">SecurityConfiguration</span><span class="o">(</span><span class="n">cli</span><span class="o">.</span><span class="na">configuration</span><span class="o">));</span>
    <span class="kt">int</span> <span class="n">retCode</span> <span class="o">=</span> <span class="n">SecurityUtils</span><span class="o">.</span><span class="na">getInstalledContext</span><span class="o">()</span>
<span class="err">★</span>            <span class="o">.</span><span class="na">runSecured</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">cli</span><span class="o">.</span><span class="na">parseParameters</span><span class="o">(</span><span class="n">args</span><span class="o">));</span>
    <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">retCode</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
解析处理参数：
<div class="codehilite"><pre><span class="n">CliFrontend</span><span class="o">.</span><span class="na">java</span>
<span class="kd">public</span> <span class="kt">int</span> <span class="nf">parseParameters</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">action</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
    <span class="c1">// remove action from parameters</span>
    <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">params</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">copyOfRange</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
    <span class="c1">// do action</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="n">ACTION_RUN</span><span class="o">:</span>
<span class="err">★</span>            <span class="n">run</span><span class="o">(</span><span class="n">params</span><span class="o">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<div class="codehilite"><pre><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">Options</span> <span class="n">commandOptions</span> <span class="o">=</span> <span class="n">CliFrontendParser</span><span class="o">.</span><span class="na">getRunCommandOptions</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">Options</span> <span class="n">commandLineOptions</span> <span class="o">=</span> <span class="n">CliFrontendParser</span><span class="o">.</span><span class="na">mergeOptions</span><span class="o">(</span><span class="n">commandOptions</span><span class="o">,</span> <span class="n">customCommandLineOptions</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">CommandLine</span> <span class="n">commandLine</span> <span class="o">=</span> <span class="n">CliFrontendParser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">commandLineOptions</span><span class="o">,</span> <span class="n">args</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">ProgramOptions</span> <span class="n">programOptions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ProgramOptions</span><span class="o">(</span><span class="n">commandLine</span><span class="o">);</span>

    <span class="kd">final</span> <span class="n">PackagedProgram</span> <span class="n">program</span><span class="o">;</span>

<span class="c1">//根据用户jar、main程序参数、savepoint信息生成PackagedProgram</span>
<span class="c1">//主要是找到用户程序的入口类+一些配置</span>
    <span class="n">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;Building program from JAR file&quot;</span><span class="o">);</span>
<span class="err">★</span>   <span class="n">program</span> <span class="o">=</span> <span class="n">buildProgram</span><span class="o">(</span><span class="n">programOptions</span><span class="o">);</span>

    <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">URL</span><span class="o">&gt;</span> <span class="n">jobJars</span> <span class="o">=</span> <span class="n">program</span><span class="o">.</span><span class="na">getJobJarAndDependencies</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">Configuration</span> <span class="n">effectiveConfiguration</span> <span class="o">=</span>
            <span class="n">getEffectiveConfiguration</span><span class="o">(</span><span class="n">commandLine</span><span class="o">,</span> <span class="n">programOptions</span><span class="o">,</span> <span class="n">jobJars</span><span class="o">);</span>

    <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Effective executor coniguration: {}&quot;</span><span class="o">,</span> <span class="n">effectiveConfiguration</span><span class="o">);</span>
<span class="c1">//执行用户程序</span>
<span class="err">★</span>    <span class="n">executeProgram</span><span class="o">(</span><span class="n">effectiveConfiguration</span><span class="o">,</span> <span class="n">program</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
//执行用户写的程序
<div class="codehilite"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">executeProgram</span><span class="o">(</span>
        <span class="n">PipelineExecutorServiceLoader</span> <span class="n">executorServiceLoader</span><span class="o">,</span>
        <span class="n">Configuration</span> <span class="n">configuration</span><span class="o">,</span> <span class="n">PackagedProgram</span> <span class="n">program</span><span class="o">){</span>
    <span class="n">checkNotNull</span><span class="o">(</span><span class="n">executorServiceLoader</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">ClassLoader</span> <span class="n">userCodeClassLoader</span> <span class="o">=</span> <span class="n">program</span><span class="o">.</span><span class="na">getUserCodeClassLoader</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">ClassLoader</span> <span class="n">contextClassLoader</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">setContextClassLoader</span><span class="o">(</span><span class="n">userCodeClassLoader</span><span class="o">);</span>
        <span class="n">ContextEnvironmentFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContextEnvironmentFactory</span><span class="o">(</span>
                <span class="n">executorServiceLoader</span><span class="o">,</span>
                <span class="n">configuration</span><span class="o">,</span> <span class="n">userCodeClassLoader</span><span class="o">);</span>
        <span class="n">ContextEnvironment</span><span class="o">.</span><span class="na">setAsContext</span><span class="o">(</span><span class="n">factory</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//使用反射执行用户代码的main()方法</span>
            <span class="c1">//执行main方法之前是假定contextEnvironment已经准备好</span>
<span class="err">★</span>            <span class="n">program</span><span class="o">.</span><span class="na">invokeInteractiveModeForExecution</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">ContextEnvironment</span><span class="o">.</span><span class="na">unsetContext</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">setContextClassLoader</span><span class="o">(</span><span class="n">contextClassLoader</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<h6 id="main">调起用户main()方法<a class="headerlink" href="#main" title="Permanent link"></a></h6>
<p><div class="codehilite"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RandomWordCount</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
<span class="err">★</span>        <span class="n">env</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">&quot;Random WordCount&quot;</span><span class="o">);</span>
 <span class="o">}}</span>
</pre></div>
<div class="codehilite"><pre><span class="kd">public</span> <span class="n">JobExecutionResult</span> <span class="nf">execute</span><span class="o">(</span><span class="n">String</span> <span class="n">jobName</span><span class="o">){</span>
    <span class="c1">// 先生成StreamGraph然后执行</span>
<span class="err">★</span>    <span class="k">return</span> <span class="n">execute</span><span class="o">(</span><span class="n">getStreamGraph</span><span class="o">(</span><span class="n">jobName</span><span class="o">));</span>
<span class="o">}</span>
</pre></div>
<div class="codehilite"><pre><span class="n">StreamExecutionEnvironment</span><span class="o">.</span><span class="na">java</span>
<span class="nd">@Internal</span>
<span class="kd">public</span> <span class="n">JobExecutionResult</span> <span class="nf">execute</span><span class="o">(</span><span class="n">StreamGraph</span> <span class="n">streamGraph</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="c1">//异步的执行streamGraph</span>
<span class="err">★</span>    <span class="kd">final</span> <span class="n">JobClient</span> <span class="n">jobClient</span> <span class="o">=</span> <span class="n">executeAsync</span><span class="o">(</span><span class="n">streamGraph</span><span class="o">);</span>
    <span class="kd">final</span> <span class="n">JobExecutionResult</span> <span class="n">jobExecutionResult</span><span class="o">;</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">configuration</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="n">DeploymentOptions</span><span class="o">.</span><span class="na">ATTACHED</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">jobExecutionResult</span> <span class="o">=</span> <span class="n">jobClient</span><span class="o">.</span><span class="na">getJobExecutionResult</span><span class="o">(</span><span class="n">userClassloader</span><span class="o">).</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">jobExecutionResult</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DetachedJobExecutionResult</span><span class="o">(</span><span class="n">jobClient</span><span class="o">.</span><span class="na">getJobID</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="n">jobListeners</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">jobListener</span> <span class="o">-&gt;</span> <span class="n">jobListener</span><span class="o">.</span><span class="na">onJobExecuted</span><span class="o">(</span><span class="n">jobExecutionResult</span><span class="o">,</span> <span class="kc">null</span><span class="o">));</span>
    <span class="k">return</span> <span class="n">jobExecutionResult</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<div class="codehilite"><pre><span class="n">StreamExecutionEnvironment</span><span class="o">.</span><span class="na">java</span>
<span class="kd">public</span> <span class="n">JobClient</span> <span class="nf">executeAsync</span><span class="o">(</span><span class="n">StreamGraph</span> <span class="n">streamGraph</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">checkNotNull</span><span class="o">(</span><span class="n">streamGraph</span><span class="o">,</span> <span class="s">&quot;StreamGraph cannot be null.&quot;</span><span class="o">);</span>
    <span class="n">checkNotNull</span><span class="o">(</span><span class="n">configuration</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">DeploymentOptions</span><span class="o">.</span><span class="na">TARGET</span><span class="o">),</span> <span class="s">&quot;No execution.target specified in your configuration file.&quot;</span><span class="o">);</span>
    <span class="c1">//PipelineExecutorFactory有两种：</span>
    <span class="c1">// YarnJobClusterExecutorFactory for executing jobs on dedicated(per-job)clusters</span>
    <span class="c1">// YarnSessionClusterExecutorFactory for executing jobs on an existing(session) clusters</span>
    <span class="kd">final</span> <span class="n">PipelineExecutorFactory</span> <span class="n">executorFactory</span> <span class="o">=</span>
        <span class="n">executorServiceLoader</span><span class="o">.</span><span class="na">getExecutorFactory</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>

<span class="c1">//其中executorFactory.getExecutor()获取的是 YarnSessionClusterExecutorFactory</span>
    <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">JobClient</span><span class="o">&gt;</span> <span class="n">jobClientFuture</span> <span class="o">=</span> <span class="n">executorFactory</span>
<span class="err">★</span>        <span class="o">.</span><span class="na">getExecutor</span><span class="o">(</span><span class="n">configuration</span><span class="o">)</span>
<span class="err">★★</span>        <span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">streamGraph</span><span class="o">,</span> <span class="n">configuration</span><span class="o">);</span>

    <span class="n">JobClient</span> <span class="n">jobClient</span> <span class="o">=</span> <span class="n">jobClientFuture</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="n">jobListeners</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">jobListener</span> <span class="o">-&gt;</span> <span class="n">jobListener</span><span class="o">.</span><span class="na">onJobSubmitted</span><span class="o">(</span><span class="n">jobClient</span><span class="o">,</span> <span class="kc">null</span><span class="o">));</span>
    <span class="k">return</span> <span class="n">jobClient</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<strong><em>----截止 ：yarn Session-Cluster 与 yarn per-job-Cluster模式公共部分----</em></strong></p>
<p>PipelineExecutorFactory有两种：</p>
<ol>
<li>YarnJobClusterExecutorFactory for executing jobs on dedicated(per-job)clusters</li>
<li>YarnSessionClusterExecutorFactory for executing jobs on an existing(session) clusters</li>
</ol>
<p><div class="codehilite"><pre><span class="n">AbstractSessionClusterExecutor</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">JobClient</span><span class="o">&gt;</span> <span class="nf">execute</span><span class="o">(</span><span class="nd">@Nonnull</span> <span class="kd">final</span> <span class="n">Pipeline</span> <span class="n">pipeline</span><span class="o">,</span> <span class="nd">@Nonnull</span> <span class="kd">final</span> <span class="n">Configuration</span> <span class="n">configuration</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">JobGraph</span> <span class="n">jobGraph</span> <span class="o">=</span> <span class="n">ExecutorUtils</span><span class="o">.</span><span class="na">getJobGraph</span><span class="o">(</span><span class="n">pipeline</span><span class="o">,</span> <span class="n">configuration</span><span class="o">);</span>

    <span class="kd">final</span> <span class="n">ClusterDescriptor</span><span class="o">&lt;</span><span class="n">ClusterID</span><span class="o">&gt;</span> <span class="n">clusterDescriptor</span> <span class="o">=</span> <span class="n">clusterClientFactory</span><span class="o">.</span><span class="na">createClusterDescriptor</span><span class="o">(</span><span class="n">configuration</span><span class="o">))</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">ClusterID</span> <span class="n">clusterID</span> <span class="o">=</span> <span class="n">clusterClientFactory</span><span class="o">.</span><span class="na">getClusterId</span><span class="o">(</span><span class="n">configuration</span><span class="o">);</span>
    <span class="n">checkState</span><span class="o">(</span><span class="n">clusterID</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
<span class="n">①</span><span class="c1">//从yarnClient中获取RestClusterClient</span>
    <span class="kd">final</span> <span class="n">ClusterClientProvider</span><span class="o">&lt;</span><span class="n">ClusterID</span><span class="o">&gt;</span> <span class="n">clusterClientProvider</span> <span class="o">=</span> <span class="n">clusterDescriptor</span><span class="o">.</span><span class="na">retrieve</span><span class="o">(</span><span class="n">clusterID</span><span class="o">);</span>
<span class="err">★★</span>  <span class="n">ClusterClient</span><span class="o">&lt;</span><span class="n">ClusterID</span><span class="o">&gt;</span> <span class="n">clusterClient</span> <span class="o">=</span> <span class="n">clusterClientProvider</span><span class="o">.</span><span class="na">getClusterClient</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">clusterClient</span>
<span class="n">②</span><span class="c1">//提交jobGraph到yarn Cluster</span>
<span class="err">★★</span>      <span class="o">.</span><span class="na">submitJob</span><span class="o">(</span><span class="n">jobGraph</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
①从yarnClient中获取RestClusterClient的具体逻辑如下
<div class="codehilite"><pre><span class="n">YarnClusterDescriptor</span><span class="o">.</span><span class="na">java</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">ClusterClientProvider</span><span class="o">&lt;</span><span class="n">ApplicationId</span><span class="o">&gt;</span> <span class="nf">retrieve</span><span class="o">(</span><span class="n">ApplicationId</span> <span class="n">applicationId</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ClusterRetrieveException</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// check if required Hadoop environment variables are set. If not, warn user</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="s">&quot;HADOOP_CONF_DIR&quot;</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span>
                <span class="n">System</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="s">&quot;YARN_CONF_DIR&quot;</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">LOG</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;Neither the HADOOP_CONF_DIR nor the YARN_CONF_DIR environment variable is set.&quot;</span> <span class="o">+</span>
                    <span class="s">&quot;The Flink YARN Client needs one of these to be set to properly load the Hadoop &quot;</span> <span class="o">+</span>
                    <span class="s">&quot;configuration for accessing YARN.&quot;</span><span class="o">);</span>
        <span class="o">}</span>
<span class="err">★</span>   <span class="kd">final</span> <span class="n">ApplicationReport</span> <span class="n">report</span> <span class="o">=</span> <span class="n">yarnClient</span><span class="o">.</span><span class="na">getApplicationReport</span><span class="o">(</span><span class="n">applicationId</span><span class="o">);</span>
    <span class="n">setClusterEntrypointInfoToConfig</span><span class="o">(</span><span class="n">report</span><span class="o">);</span>
    <span class="k">return</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
<span class="err">★</span>        <span class="k">return</span> <span class="k">new</span> <span class="n">RestClusterClient</span><span class="o">&lt;&gt;(</span><span class="n">flinkConfiguration</span><span class="o">,</span> <span class="n">report</span><span class="o">.</span><span class="na">getApplicationId</span><span class="o">());</span>
    <span class="o">};</span>
<span class="o">}</span>
</pre></div>
经过上述步骤，客户端提交任务过程就完成了，主要就是通过RestClusterClient将用户程序的JobGraph通过Rest接口提交至集群中。</p>
<h5 id="_4">总结<a class="headerlink" href="#_4" title="Permanent link"></a></h5>
<p>上述过程流程图如下：</p>
<p><img alt="" src="/Users/liaomengjie/workspace/learngit/leetcode/todo/Flink/YarnSession%E6%A8%A1%E5%BC%8F%E4%B8%8B%E6%8F%90%E4%BA%A4%E4%BD%9C%E4%B8%9A%E6%B5%81%E7%A8%8B%E5%9B%BE.png" /></p>
<h4 id="34-_1">3.4、启动作业流程分析&ndash;远端<a class="headerlink" href="#34-_1" title="Permanent link"></a></h4>
<p>在Yarn Session Cluster中响应客户端提交作业请求(RestClusterClient.submit(jobGraph))的是：RestServerEndpoint，其中包含了多个Handler，其中JobSubmitHandler用户处理任务提交的请求；</p>
<p>RestServerEndpoint:An abstract class for netty-based REST server endpoints.</p>
<p><img alt="" src="/Users/liaomengjie/workspace/learngit/leetcode/todo/Flink/RestServeEndpoint.png" /></p>
<p>处理请求入口：RestServerEndpoint中 JobSubmitHandler#handleRequest</p>
<p>RestServerEndpoint的启动入口：</p>
<p>ClusterEntrypoint#.runCluster()&ndash;&gt;DefaultDispatcherResourceManagerComponentFactory#create()&ndash;&gt;webMonitorEndpoint.start();</p>
<div class="codehilite"><pre><span class="n">DispatcherRestEndpoint</span> <span class="kd">extends</span> <span class="n">WebMonitorEndpoint</span> <span class="kd">extends</span> <span class="n">RestServerEndpoint</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">RestHandlerSpecification</span><span class="o">,</span> <span class="n">ChannelInboundHandler</span><span class="o">&gt;&gt;</span> <span class="nf">initializeHandlers</span><span class="o">(</span><span class="kd">final</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">localAddressFuture</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">RestHandlerSpecification</span><span class="o">,</span> <span class="n">ChannelInboundHandler</span><span class="o">&gt;&gt;</span> <span class="n">handlers</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">initializeHandlers</span><span class="o">(</span><span class="n">localAddressFuture</span><span class="o">);</span>

    <span class="c1">// Add the Dispatcher specific handlers</span>
    <span class="kd">final</span> <span class="n">Time</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">restConfiguration</span><span class="o">.</span><span class="na">getTimeout</span><span class="o">();</span>
<span class="c1">// jobSubmitHandler 用来处理客户端submit(jobgraph)请求</span>
<span class="err">★</span>    <span class="n">JobSubmitHandler</span> <span class="n">jobSubmitHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JobSubmitHandler</span><span class="o">(</span>
        <span class="n">leaderRetriever</span><span class="o">,</span>
        <span class="n">timeout</span><span class="o">,</span>
        <span class="n">responseHeaders</span><span class="o">,</span>
        <span class="n">executor</span><span class="o">,</span>
        <span class="n">clusterConfiguration</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>

<p><div class="codehilite"><pre><span class="n">JobSubmitHandler</span><span class="o">.</span><span class="na">java</span>
<span class="nd">@Override</span>
<span class="kd">protected</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">JobSubmitResponseBody</span><span class="o">&gt;</span> <span class="nf">handleRequest</span><span class="o">(</span><span class="nd">@Nonnull</span> <span class="n">HandlerRequest</span><span class="o">&lt;</span><span class="n">JobSubmitRequestBody</span><span class="o">,</span> <span class="n">EmptyMessageParameters</span><span class="o">&gt;</span> <span class="n">request</span><span class="o">,</span> <span class="nd">@Nonnull</span> <span class="n">DispatcherGateway</span> <span class="n">gateway</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">RestHandlerException</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">uploadedFiles</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getUploadedFiles</span><span class="o">();</span>
    <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Path</span><span class="o">&gt;</span> <span class="n">nameToFile</span> <span class="o">=</span> <span class="n">uploadedFiles</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toMap</span><span class="o">(</span>
        <span class="n">File</span><span class="o">::</span><span class="n">getName</span><span class="o">,</span>
        <span class="n">Path</span><span class="o">::</span><span class="n">fromLocalFile</span>
    <span class="o">));</span>
    <span class="c1">//进行相关验证</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">uploadedFiles</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">!=</span> <span class="n">nameToFile</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RestHandlerException</span><span class="o">(</span>
            <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;The number of uploaded files was %s than the expected count. Expected: %s Actual %s&quot;</span><span class="o">,</span>
                <span class="n">uploadedFiles</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">nameToFile</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">?</span> <span class="s">&quot;lower&quot;</span> <span class="o">:</span> <span class="s">&quot;higher&quot;</span><span class="o">,</span>
                <span class="n">nameToFile</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span>
                <span class="n">uploadedFiles</span><span class="o">.</span><span class="na">size</span><span class="o">()),</span>
            <span class="n">HttpResponseStatus</span><span class="o">.</span><span class="na">BAD_REQUEST</span>
        <span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">final</span> <span class="n">JobSubmitRequestBody</span> <span class="n">requestBody</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getRequestBody</span><span class="o">();</span>
    <span class="c1">//1. 进行相关验证</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">requestBody</span><span class="o">.</span><span class="na">jobGraphFileName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">RestHandlerException</span><span class="o">(</span>
            <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;The %s field must not be omitted or be null.&quot;</span><span class="o">,</span>
                <span class="n">JobSubmitRequestBody</span><span class="o">.</span><span class="na">FIELD_NAME_JOB_GRAPH</span><span class="o">),</span>
            <span class="n">HttpResponseStatus</span><span class="o">.</span><span class="na">BAD_REQUEST</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//2. 从文件中取出JobGraph</span>
    <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">JobGraph</span><span class="o">&gt;</span> <span class="n">jobGraphFuture</span> <span class="o">=</span> <span class="n">loadJobGraph</span><span class="o">(</span><span class="n">requestBody</span><span class="o">,</span> <span class="n">nameToFile</span><span class="o">);</span>
    <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">&gt;</span> <span class="n">jarFiles</span> <span class="o">=</span> <span class="n">getJarFilesToUpload</span><span class="o">(</span><span class="n">requestBody</span><span class="o">.</span><span class="na">jarFileNames</span><span class="o">,</span> <span class="n">nameToFile</span><span class="o">);</span>

    <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Path</span><span class="o">&gt;&gt;</span> <span class="n">artifacts</span> <span class="o">=</span> <span class="n">getArtifactFilesToUpload</span><span class="o">(</span><span class="n">requestBody</span><span class="o">.</span><span class="na">artifactFileNames</span><span class="o">,</span> <span class="n">nameToFile</span><span class="o">);</span>

    <span class="c1">//3. 通过BlobClient将jar及JobGraph文件上传至BlobServer</span>
    <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">JobGraph</span><span class="o">&gt;</span> <span class="n">finalizedJobGraphFuture</span> <span class="o">=</span> <span class="n">uploadJobGraphFiles</span><span class="o">(</span><span class="n">gateway</span><span class="o">,</span> <span class="n">jobGraphFuture</span><span class="o">,</span> <span class="n">jarFiles</span><span class="o">,</span> <span class="n">artifacts</span><span class="o">,</span> <span class="n">configuration</span><span class="o">);</span>
    <span class="c1">//4. 通过Dispatcher#submitJob提交JobGraph</span>
<span class="err">★</span>    <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Acknowledge</span><span class="o">&gt;</span> <span class="n">jobSubmissionFuture</span> <span class="o">=</span>
<span class="err">★</span>        <span class="n">finalizedJobGraphFuture</span><span class="o">.</span><span class="na">thenCompose</span><span class="o">(</span><span class="n">jobGraph</span> <span class="o">-&gt;</span> <span class="n">gateway</span><span class="o">.</span><span class="na">submitJob</span><span class="o">(</span><span class="n">jobGraph</span><span class="o">,</span> <span class="n">timeout</span><span class="o">));</span>

    <span class="k">return</span> <span class="n">jobSubmissionFuture</span><span class="o">.</span><span class="na">thenCombine</span><span class="o">(</span><span class="n">jobGraphFuture</span><span class="o">,</span>
        <span class="o">(</span><span class="n">ack</span><span class="o">,</span> <span class="n">jobGraph</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">JobSubmitResponseBody</span><span class="o">(</span><span class="s">&quot;/jobs/&quot;</span> <span class="o">+</span> <span class="n">jobGraph</span><span class="o">.</span><span class="na">getJobID</span><span class="o">()));</span>
<span class="o">}</span>
</pre></div>
Handler接受到请求后的主要逻辑：</p>
<ol>
<li>进行相关验证</li>
<li>从文件中取出JobGraph</li>
<li>通过BlobClient将jar及JobGraph文件上传至BlobServer</li>
<li>通过Dispatcher#submitJob提交JobGraph</li>
</ol>
<p>handler通过gateway.submitJob提交作业给JobMaster
<div class="codehilite"><pre><span class="n">Dispatcher</span><span class="o">.</span><span class="na">java</span>
<span class="c1">// 【重点】提交作业</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Acknowledge</span><span class="o">&gt;</span> <span class="nf">submitJob</span><span class="o">(</span><span class="n">JobGraph</span> <span class="n">jobGraph</span><span class="o">,</span> <span class="n">Time</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
<span class="err">★</span>    <span class="k">return</span> <span class="n">internalSubmitJob</span><span class="o">(</span><span class="n">jobGraph</span><span class="o">);</span>
<span class="o">}</span>

<span class="n">注意</span><span class="err">：</span><span class="n">下面的代码中将作业Job的持久化和运行放在了一个方法中</span><span class="o">--</span><span class="n">persistAndRunJob</span><span class="o">()</span>
<span class="kd">private</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Acknowledge</span><span class="o">&gt;</span> <span class="nf">internalSubmitJob</span><span class="o">(</span><span class="n">JobGraph</span> <span class="n">jobGraph</span><span class="o">)</span> <span class="o">{</span>
<span class="c1">//this::persistAndRunJob其实是调用persistAndRunJob()方法</span>
<span class="err">★★</span>    <span class="kd">final</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Acknowledge</span><span class="o">&gt;</span> <span class="n">persistAndRunFuture</span> <span class="o">=</span> <span class="n">waitForTerminatingJobManager</span><span class="o">(</span><span class="n">jobGraph</span><span class="o">.</span><span class="na">getJobID</span><span class="o">(),</span>
        <span class="n">jobGraph</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">persistAndRunJob</span><span class="o">)</span>
        <span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="n">ignored</span> <span class="o">-&gt;</span> <span class="n">Acknowledge</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>

    <span class="k">return</span> <span class="n">persistAndRunFuture</span><span class="o">.</span><span class="na">handleAsync</span><span class="o">((</span><span class="n">acknowledge</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">acknowledge</span><span class="o">;</span>
    <span class="o">},</span> <span class="n">getRpcService</span><span class="o">().</span><span class="na">getExecutor</span><span class="o">());</span>
<span class="o">}</span>
</pre></div>
<div class="codehilite"><pre><span class="n">Dispatcher</span><span class="o">.</span><span class="na">java</span>
<span class="c1">//【重点】持久化作业</span>
<span class="kd">private</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">persistAndRunJob</span><span class="o">(</span><span class="n">JobGraph</span> <span class="n">jobGraph</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//先将作业进行持久化</span>
    <span class="n">jobGraphWriter</span><span class="o">.</span><span class="na">putJobGraph</span><span class="o">(</span><span class="n">jobGraph</span><span class="o">);</span>
    <span class="c1">//通过Dispatcher#runJob 运行jobGraph</span>
    <span class="kd">final</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">runJobFuture</span> <span class="o">=</span> <span class="n">runJob</span><span class="o">(</span><span class="n">jobGraph</span><span class="o">);</span>
<span class="o">}</span>
</pre></div></p>
<p><div class="codehilite"><pre><span class="n">Dispatcher</span><span class="o">.</span><span class="na">java</span>
<span class="kd">private</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">runJob</span><span class="o">(</span><span class="n">JobGraph</span> <span class="n">jobGraph</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Preconditions</span><span class="o">.</span><span class="na">checkState</span><span class="o">(!</span><span class="n">jobManagerRunnerFutures</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">jobGraph</span><span class="o">.</span><span class="na">getJobID</span><span class="o">()));</span>
    <span class="c1">//1. 启动JobMaster</span>
<span class="err">★★</span><span class="n">①</span>    <span class="kd">final</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">JobManagerRunner</span><span class="o">&gt;</span> <span class="n">jobManagerRunnerFuture</span> <span class="o">=</span> <span class="n">createJobManagerRunner</span><span class="o">(</span><span class="n">jobGraph</span><span class="o">);</span>
    <span class="c1">//2. 将&lt;jobID，JobManagerRunner&gt;保存至Map</span>
    <span class="n">jobManagerRunnerFutures</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">jobGraph</span><span class="o">.</span><span class="na">getJobID</span><span class="o">(),</span> <span class="n">jobManagerRunnerFuture</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">jobManagerRunnerFuture</span>
        <span class="c1">// 通过this::startJobManagerRunner即调用startJobManagerRunner()方法</span>
        <span class="c1">//3. 启动JobMaster</span>
<span class="err">★★</span><span class="n">②</span>        <span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="n">FunctionUtils</span><span class="o">.</span><span class="na">uncheckedFunction</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">startJobManagerRunner</span><span class="o">))</span>
        <span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="n">FunctionUtils</span><span class="o">.</span><span class="na">nullFn</span><span class="o">())</span>
        <span class="o">.</span><span class="na">whenCompleteAsync</span><span class="o">(</span>
            <span class="o">(</span><span class="n">ignored</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">throwable</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">jobManagerRunnerFutures</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">jobGraph</span><span class="o">.</span><span class="na">getJobID</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">},</span>
            <span class="n">getMainThreadExecutor</span><span class="o">());</span>
<span class="o">}</span>
</pre></div>
在Dispatcher#runJob(jobGraph)的逻辑中主要做了以下几件事：</p>
<ol>
<li>启动JobMaster</li>
<li>将（jobID，JobManagerRunner）保存至Map</li>
<li>启动JobMaster</li>
</ol>
<h5 id="jobmanagerjobmaster">创建并启动JobManager(jobMaster)<a class="headerlink" href="#jobmanagerjobmaster" title="Permanent link"></a></h5>
<p><div class="codehilite"><pre><span class="n">Dispatcher</span><span class="o">.</span><span class="na">java</span>
<span class="c1">//①【重点】创建对应的JobManager（处理leader选举）</span>
<span class="kd">private</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">JobManagerRunner</span><span class="o">&gt;</span> <span class="nf">createJobManagerRunner</span><span class="o">(</span><span class="n">JobGraph</span> <span class="n">jobGraph</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">RpcService</span> <span class="n">rpcService</span> <span class="o">=</span> <span class="n">getRpcService</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(</span>
        <span class="n">CheckedSupplier</span><span class="o">.</span><span class="na">unchecked</span><span class="o">(()</span> <span class="o">-&gt;</span>
            <span class="c1">//创建JobMaster</span>
<span class="err">★★</span>            <span class="n">jobManagerRunnerFactory</span><span class="o">.</span><span class="na">createJobManagerRunner</span><span class="o">(</span>
                <span class="n">jobGraph</span><span class="o">,</span> <span class="n">configuration</span><span class="o">,</span>
                <span class="n">rpcService</span><span class="o">,</span> <span class="n">highAvailabilityServices</span><span class="o">,</span>
                <span class="n">heartbeatServices</span><span class="o">,</span> <span class="n">jobManagerSharedServices</span><span class="o">,</span>
                <span class="k">new</span> <span class="n">DefaultJobManagerJobMetricGroupFactory</span><span class="o">(</span><span class="n">jobManagerMetricGroup</span><span class="o">),</span> <span class="n">fatalErrorHandler</span><span class="o">)),</span>
        <span class="n">rpcService</span><span class="o">.</span><span class="na">getExecutor</span><span class="o">());</span>
<span class="o">}</span>

<span class="c1">//②【重点】启动对应的JobManager(JobMaster)</span>
<span class="kd">private</span> <span class="n">JobManagerRunner</span> <span class="nf">startJobManagerRunner</span><span class="o">(</span><span class="n">JobManagerRunner</span> <span class="n">jobManagerRunner</span><span class="o">){</span>
    <span class="kd">final</span> <span class="n">JobID</span> <span class="n">jobId</span> <span class="o">=</span> <span class="n">jobManagerRunner</span><span class="o">.</span><span class="na">getJobID</span><span class="o">();</span>
<span class="c1">//启动JobMaster（会进行leader选举，ZK目录为leader/${jobId}/job_manager_lock）</span>
<span class="err">★★</span>    <span class="n">jobManagerRunner</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">jobManagerRunner</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<div class="codehilite"><pre><span class="n">JobManagerRunnerImpl</span><span class="o">.</span><span class="na">java</span>
<span class="nd">@Override</span><span class="err">（</span><span class="n">会进行leader选举</span><span class="err">，</span><span class="n">ZK目录为leader</span><span class="o">/</span><span class="n">$</span><span class="o">{</span><span class="n">jobId</span><span class="o">}/</span><span class="n">job_manager_lock</span><span class="err">）</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="c1">//start the leader election service</span>
    <span class="c1">//（会进行leader选举，ZK目录为leader/${jobId}/job_manager_lock）</span>
    <span class="n">leaderElectionService</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
当某个jobManager称为leader的时候，会调用ZooKeeperLederElectionService#isLeader()
<div class="codehilite"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">isLeader</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">running</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">issuedLeaderSessionID</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">();</span>
            <span class="n">clearConfirmedLeaderInformation</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">LOG</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span>
                    <span class="s">&quot;Grant leadership to contender {} with session ID {}.&quot;</span><span class="o">,</span>
                    <span class="n">leaderContender</span><span class="o">.</span><span class="na">getDescription</span><span class="o">(),</span><span class="n">issuedLeaderSessionID</span><span class="o">);</span>
            <span class="o">}</span>

<span class="err">★</span>            <span class="n">leaderContender</span><span class="o">.</span><span class="na">grantLeadership</span><span class="o">(</span><span class="n">issuedLeaderSessionID</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">LOG</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Ignoring the grant leadership notification since the service has &quot;</span> <span class="o">+</span><span class="s">&quot;already been stopped.&quot;</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></div>
<div class="codehilite"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">grantLeadership</span><span class="o">(</span><span class="kd">final</span> <span class="n">UUID</span> <span class="n">leaderSessionID</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">shutdown</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;JobManagerRunner already shutdown.&quot;</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">leadershipOperation</span> <span class="o">=</span> <span class="n">leadershipOperation</span><span class="o">.</span><span class="na">thenCompose</span><span class="o">(</span>
            <span class="o">(</span><span class="n">ignored</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                 <span class="c1">//调起JobMaster</span>
<span class="err">★★</span>        <span class="k">return</span> <span class="n">verifyJobSchedulingStatusAndStartJobManager</span><span class="o">(</span><span class="n">leaderSessionID</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
    <span class="n">handleException</span><span class="o">(</span><span class="n">leadershipOperation</span><span class="o">,</span> <span class="s">&quot;Could not start the job manager.&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<div class="codehilite"><pre><span class="n">JobManagerRunnerImpl</span><span class="o">.</span><span class="na">java</span>
<span class="kd">private</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">verifyJobSchedulingStatusAndStartJobManager</span><span class="o">(</span><span class="n">UUID</span> <span class="n">leaderSessionId</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">JobSchedulingStatus</span><span class="o">&gt;</span> <span class="n">jobSchedulingStatusFuture</span> <span class="o">=</span> <span class="n">getJobSchedulingStatus</span><span class="o">();</span>

    <span class="k">return</span> <span class="n">jobSchedulingStatusFuture</span><span class="o">.</span><span class="na">thenCompose</span><span class="o">(</span>
        <span class="n">jobSchedulingStatus</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">jobSchedulingStatus</span> <span class="o">==</span> <span class="n">JobSchedulingStatus</span><span class="o">.</span><span class="na">DONE</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">jobAlreadyDone</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="err">★</span>                <span class="k">return</span> <span class="n">startJobMaster</span><span class="o">(</span><span class="n">leaderSessionId</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="nf">startJobMaster</span><span class="o">(</span><span class="n">UUID</span> <span class="n">leaderSessionId</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">runningJobsRegistry</span><span class="o">.</span><span class="na">setJobRunning</span><span class="o">(</span><span class="n">jobGraph</span><span class="o">.</span><span class="na">getJobID</span><span class="o">());</span>

    <span class="kd">final</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Acknowledge</span><span class="o">&gt;</span> <span class="n">startFuture</span><span class="o">;</span>
    <span class="c1">//开始调度任务JobMaster#startJobExecution</span>
<span class="err">★★</span>    <span class="n">startFuture</span> <span class="o">=</span> <span class="n">jobMasterService</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="k">new</span> <span class="n">JobMasterId</span><span class="o">(</span><span class="n">leaderSessionId</span><span class="o">));</span>

    <span class="kd">final</span> <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">JobMasterGateway</span><span class="o">&gt;</span> <span class="n">currentLeaderGatewayFuture</span> <span class="o">=</span> <span class="n">leaderGatewayFuture</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">startFuture</span><span class="o">.</span><span class="na">thenAcceptAsync</span><span class="o">(</span>
        <span class="o">(</span><span class="n">Acknowledge</span> <span class="n">ack</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">confirmLeaderSessionIdIfStillLeader</span><span class="o">(</span>
            <span class="n">leaderSessionId</span><span class="o">,</span> <span class="n">jobMasterService</span><span class="o">.</span><span class="na">getAddress</span><span class="o">(),</span>
            <span class="n">currentLeaderGatewayFuture</span><span class="o">),</span> <span class="n">executor</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
至此JobMaster真正启动，并通过 jobMasterService.start()调用JobMaster#startJobExecution，执行任务。接下来就进行任务具体调度（构造ExecutionGraph、申请Slot等）流程，本篇文章不再展开介绍。</p>
<h5 id="_5">总结<a class="headerlink" href="#_5" title="Permanent link"></a></h5>
<p>session模式后端逻辑如下：</p>
<p><img alt="" src="/Users/liaomengjie/workspace/learngit/leetcode/todo/Flink/session%E6%A8%A1%E5%BC%8F%E5%90%8E%E7%AB%AF%E9%80%BB%E8%BE%91.png" /></p>
<h3 id="4per-job-cluster">4、Per-Job-Cluster模式：<a class="headerlink" href="#4per-job-cluster" title="Permanent link"></a></h3>
<p>一个任务会对应一个Job，每提交一个作业会根据自身的情况，都会向yarn申请资源，知道作业执行完成。一个作业的失败与否并不会影响下一个作业的正常提交和运行。独享Dipatcher和ResourceManager,按需接收资源申请；适合规模大长时间运行的作业。</p>
<p><img alt="" src="/Users/liaomengjie/workspace/learngit/leetcode/todo/Flink/PerJobCluster%E6%A8%A1%E5%BC%8F.png" /></p>
<p>Session-cluster模式需要先启动集群，然后再提交作业。但是per-job不需要先启动集群，直接提交任务即可。</p>
<h4 id="41">4.1、启动任务<a class="headerlink" href="#41" title="Permanent link"></a></h4>
<p>启动Per-job-Cluster任务，可通过./bin/flink run -m yarn-cluster -d -c mainClass /path/to/jar命令使用分离模式启动一个集群，即单任务单集群；</p>
<h4 id="42">4.2、流程分析<a class="headerlink" href="#42" title="Permanent link"></a></h4>
<p>与Session-Cluster类似，我们对Per-Job-Cluster模式也分为本地和远端。</p>
<h5 id="421">4.2.1、本地流程<a class="headerlink" href="#421" title="Permanent link"></a></h5>
<p>与Session-Cluster模式类似，入口也为CliFrontend#main。接下来解析处理参数，根据jar、main、程序参数、savepoint信息生成PackagedProgram，根据PackageProgram创建JobGraph,获取集群资源信息都与Session-Cluster类似。</p>
<p>从执行脚本开始经过如下步骤都是与Session-Cluster是类似的：</p>
<p>flink.sh&ndash;&gt;程序入口CliFrontend#main&ndash;&gt;CliFrontend#run()&ndash;&gt;CliFrontend#executeProgram()&ndash;&gt;UserFlinkCode#main()&ndash;&gt;StreamExecutionEnvironment#execute()&ndash;&gt;StreamExecutionEnvironment#executeAsync()&ndash;&gt;PipelineExecutor#execute()</p>
<p>PipelineExecutorFactory是 <strong><em>一个负责执行Job的对象</em></strong>，PipelineExecutorFactory的实现类有两种如下：</p>
<ol>
<li>YarnJobClusterExecutorFactory for executing jobs on dedicated(per-job)clusters</li>
<li>YarnSessionClusterExecutorFactory for executing jobs on an existing(session) clusters</li>
</ol>
<h6 id="yarnsessionclusteryarnjobcluster1">YarnSessionCluster与YarnJobCluster的区别1<a class="headerlink" href="#yarnsessionclusteryarnjobcluster1" title="Permanent link"></a></h6>
<p><img alt="" src="/Users/liaomengjie/workspace/learngit/leetcode/todo/Flink/session%E6%A8%A1%E5%BC%8Fper-job%E6%A8%A1%E5%BC%8F%E5%8C%BA%E5%88%AB1.png" /></p>
<p>接下来会调用ClusterDescriptor#deployJobCluster()
&ndash;&gt;YarnClusterDescriptor#deployJobCluster()
&ndash; &ndash;&gt;YarnClusterDescriptor#deployInternal()
&ndash; &ndash; &ndash;&gt;YarnClusterDescriptor#startAppMaster()</p>
<p><div class="codehilite"><pre><span class="n">YarnClusterDescriptor</span><span class="o">.</span><span class="na">java</span>
<span class="c1">//在startAppMaster方法中只展示了per-job(jobGraph!=null的情况下)与session模式的区别：</span>
<span class="kd">private</span> <span class="n">ApplicationReport</span> <span class="nf">startAppMaster</span><span class="o">(){</span>
    <span class="kd">final</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">userJarFiles</span> <span class="o">=</span> <span class="o">(</span><span class="n">jobGraph</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="c1">// not per-job submission</span>
        <span class="o">?</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptySet</span><span class="o">()</span>
        <span class="c1">// add user code jars from the provided JobGraph</span>
        <span class="o">:</span> <span class="n">jobGraph</span><span class="o">.</span><span class="na">getUserJars</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">f</span><span class="o">.</span><span class="na">toUri</span><span class="o">()).</span><span class="na">map</span><span class="o">(</span><span class="n">File</span><span class="o">::</span><span class="k">new</span><span class="o">).</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toSet</span><span class="o">());</span>
<span class="c1">//值得注意的是在startAppMaster中per-job cluster与session cluster的一个显著的区别：</span>
<span class="c1">//就是其会将任务的JobGraph上传至Hdfs供后续服务继续使用（即）</span>
    <span class="c1">// only for per job mode</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">jobGraph</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">DistributedCache</span><span class="o">.</span><span class="na">DistributedCacheEntry</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">jobGraph</span><span class="o">.</span><span class="na">getUserArtifacts</span><span class="o">().</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">flink</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">fs</span><span class="o">.</span><span class="na">Path</span> <span class="n">path</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">flink</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">fs</span><span class="o">.</span><span class="na">Path</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">filePath</span><span class="o">);</span>
            <span class="c1">// only upload local files</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">path</span><span class="o">.</span><span class="na">getFileSystem</span><span class="o">().</span><span class="na">isDistributedFS</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">Path</span> <span class="n">localPath</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Path</span><span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">getPath</span><span class="o">());</span>
                <span class="n">Tuple2</span><span class="o">&lt;</span><span class="n">Path</span><span class="o">,</span> <span class="n">Long</span><span class="o">&gt;</span> <span class="n">remoteFileInfo</span> <span class="o">=</span>
                    <span class="n">Utils</span><span class="o">.</span><span class="na">uploadLocalFileToRemote</span><span class="o">(</span><span class="n">fs</span><span class="o">,</span> <span class="n">appId</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">localPath</span><span class="o">,</span> <span class="n">homeDir</span><span class="o">,</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">());</span>
                <span class="n">jobGraph</span><span class="o">.</span><span class="na">setUserArtifactRemotePath</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">remoteFileInfo</span><span class="o">.</span><span class="na">f0</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">jobGraph</span><span class="o">.</span><span class="na">writeUserArtifactEntriesToConfiguration</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
值得注意的是在startAppMaster中per-job cluster与session cluster的一个显著的区别： 就是其会将任务的JobGraph上传至Hdfs供后续服务继续使用，即不需要像Session Cluster那样启动cluster 的AppMaster后使用restClusterClient.submit(jobGraph)；而只需要在当前jobGraph对应的yarn cluster从HDFS取出jobGraph进行处理；</p>
<h5 id="_6">总结<a class="headerlink" href="#_6" title="Permanent link"></a></h5>
<p>上述流程图如下：</p>
<p><img alt="" src="/Users/liaomengjie/workspace/learngit/leetcode/todo/Flink/YarnPerJob%E6%A8%A1%E5%BC%8F%E4%B8%8B%E6%8F%90%E4%BA%A4%E4%BD%9C%E4%B8%9A%E6%B5%81%E7%A8%8B%E5%9B%BE.png" /></p>
<h5 id="422">4.2.2、远端流程<a class="headerlink" href="#422" title="Permanent link"></a></h5>
<p>Flink per-job-Cluster模式的入口是YarnJobClusterEntrypoint#main</p>
<h6 id="cluster">cluster 启动流程大致如下：<a class="headerlink" href="#cluster" title="Permanent link"></a></h6>
<div class="codehilite"><pre><span class="n">YarnJobClusterEntrypoint</span><span class="err">#</span><span class="n">main</span><span class="o">()</span>
<span class="o">--&gt;</span><span class="n">ClusterEntrypoint</span><span class="err">#</span><span class="n">runClusterEntrypoint</span><span class="o">()</span>
<span class="o">--</span> <span class="o">--&gt;</span><span class="n">ClusterEntrypoint</span><span class="err">#</span><span class="n">startCluster</span><span class="o">()</span>
<span class="o">--</span> <span class="o">--</span> <span class="o">--&gt;</span><span class="n">ClusterEntrypoint</span><span class="err">#</span><span class="n">runCluster</span><span class="o">()</span>
<span class="o">--</span> <span class="o">--</span> <span class="o">--</span> <span class="o">--&gt;</span><span class="n">DispatcherResourceManagerComponentFactory</span><span class="err">#</span><span class="n">create</span><span class="o">()</span>
<span class="o">--</span> <span class="o">--</span> <span class="o">--</span> <span class="o">--</span> <span class="o">--&gt;</span><span class="n">DefaultDispatcherResourceManagerComponentFactory</span><span class="err">#</span><span class="n">create</span><span class="o">()</span><span class="n">f</span>
<span class="n">①</span><span class="o">--</span> <span class="o">--</span> <span class="o">--</span> <span class="o">--</span> <span class="o">--</span> <span class="o">--&gt;</span><span class="n">dispatcherRunner</span> <span class="o">=</span> <span class="n">dispatcherRunnerFactory</span><span class="o">.</span><span class="na">createDispatcherRunner</span><span class="o">()</span>
</pre></div>

<p>上述流程与Flink session cluster模式的启动流程一致，那么不同点在哪呢？前面已经讲到了在客户端的时候，客户端只是将JobGraph发送只HDFS，而并没有像session模式下客户端会在启动AppMaster之后再次调用restClusterClient.submit(jobGraph); 那么在Flink per-job-Cluster模式下启动AppMaster的时候在那一步（被遗漏了）其实已经从HDFS中读取出jobGraph供dispatcher发送给JobMaster呢？</p>
<p>答案其实就在下面：</p>
<p>在DefaultDispatcherResourceManagerComponentFactory#create()方法中会有一个 <strong>创建dispatcher的逻辑：</strong>
<div class="codehilite"><pre><span class="n">dispatcherRunner</span> <span class="o">=</span> <span class="n">dispatcherRunnerFactory</span><span class="o">.</span><span class="na">createDispatcherRunner</span><span class="o">()</span>
</pre></div></p>
<p>上面的方法会启动Dispatcher并进行ZK选举、及创建JobGraph
<div class="codehilite"><pre><span class="n">DispatcherRunnerFactory</span><span class="o">.</span><span class="na">java</span>
<span class="n">DispatcherRunner</span> <span class="nf">createDispatcherRunner</span><span class="o">(</span>
        <span class="n">LeaderElectionService</span> <span class="n">leaderElectionService</span><span class="o">,</span>
        <span class="n">FatalErrorHandler</span> <span class="n">fatalErrorHandler</span><span class="o">,</span>
        <span class="n">JobGraphStoreFactory</span> <span class="n">jobGraphStoreFactory</span><span class="o">,</span>
        <span class="n">Executor</span> <span class="n">ioExecutor</span><span class="o">,</span>
        <span class="n">RpcService</span> <span class="n">rpcService</span><span class="o">,</span>
        <span class="n">PartialDispatcherServices</span> <span class="n">partialDispatcherServices</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
</pre></div>
<div class="codehilite"><pre><span class="n">DefaultDispatcherRunnerFactory</span><span class="o">.</span><span class="na">java</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">DispatcherRunner</span> <span class="nf">createDispatcherRunner</span><span class="o">(</span>
        <span class="n">LeaderElectionService</span> <span class="n">leaderElectionService</span><span class="o">,</span>
        <span class="n">FatalErrorHandler</span> <span class="n">fatalErrorHandler</span><span class="o">,</span>
        <span class="n">JobGraphStoreFactory</span> <span class="n">jobGraphStoreFactory</span><span class="o">,</span>
        <span class="n">Executor</span> <span class="n">ioExecutor</span><span class="o">,</span>
        <span class="n">RpcService</span> <span class="n">rpcService</span><span class="o">,</span>
        <span class="n">PartialDispatcherServices</span> <span class="n">partialDispatcherServices</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
<span class="c1">//创建JobGraph</span>
<span class="c1">//createFactory分为JobDispatcherLeaderProcessFactoryFactory和SessionDispatcherLeaderProcessFactoryFactory</span>
<span class="err">★★</span>    <span class="kd">final</span> <span class="n">DispatcherLeaderProcessFactory</span> <span class="n">dispatcherLeaderProcessFactory</span> <span class="o">=</span>
<span class="err">★★</span>      <span class="n">dispatcherLeaderProcessFactoryFactory</span><span class="o">.</span><span class="na">createFactory</span><span class="o">(</span>
        <span class="n">jobGraphStoreFactory</span><span class="o">,</span> <span class="n">ioExecutor</span><span class="o">,</span>
        <span class="n">rpcService</span><span class="o">,</span> <span class="n">partialDispatcherServices</span><span class="o">,</span>
        <span class="n">fatalErrorHandler</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">DefaultDispatcherRunner</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">leaderElectionService</span><span class="o">,</span> <span class="n">fatalErrorHandler</span><span class="o">,</span> <span class="n">dispatcherLeaderProcessFactory</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
DispatcherLeaderProcessFactoryFactory的子类有 <strong>JobDispatcherLeaderProcessFactoryFactory和SessionDispatcherLeaderProcessFactoryFactory</strong></p>
<p><img alt="" src="/Users/liaomengjie/workspace/learngit/leetcode/todo/Flink/DispatcherLeaderProcessFactoryFactoryUML.png" /></p>
<p><div class="codehilite"><pre><span class="n">JobDispatcherLeaderProcessFactoryFactory</span><span class="o">.</span><span class="na">java</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">DispatcherLeaderProcessFactory</span> <span class="nf">createFactory</span><span class="o">(</span>
        <span class="n">JobGraphStoreFactory</span> <span class="n">jobGraphStoreFactory</span><span class="o">,</span>
        <span class="n">Executor</span> <span class="n">ioExecutor</span><span class="o">,</span> <span class="n">RpcService</span> <span class="n">rpcService</span><span class="o">,</span>
        <span class="n">PartialDispatcherServices</span> <span class="n">partialDispatcherServices</span><span class="o">,</span>
        <span class="n">FatalErrorHandler</span> <span class="n">fatalErrorHandler</span><span class="o">)</span> <span class="o">{</span>

    <span class="kd">final</span> <span class="n">JobGraph</span> <span class="n">jobGraph</span><span class="o">;</span>
    <span class="c1">//创建jobGraph</span>
<span class="err">★★</span>  <span class="n">jobGraph</span> <span class="o">=</span> <span class="n">jobGraphRetriever</span><span class="o">.</span><span class="na">retrieveJobGraph</span><span class="o">(</span><span class="n">partialDispatcherServices</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">());</span>

    <span class="kd">final</span> <span class="n">DefaultDispatcherGatewayServiceFactory</span> <span class="n">defaultDispatcherServiceFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultDispatcherGatewayServiceFactory</span><span class="o">(</span><span class="n">JobDispatcherFactory</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">,</span>
        <span class="n">rpcService</span><span class="o">,</span><span class="n">partialDispatcherServices</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">JobDispatcherLeaderProcessFactory</span><span class="o">(</span>
        <span class="n">defaultDispatcherServiceFactory</span><span class="o">,</span>
        <span class="n">jobGraph</span><span class="o">,</span><span class="n">fatalErrorHandler</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<div class="codehilite"><pre><span class="n">SessionDispatcherLeaderProcessFactoryFactory</span><span class="o">.</span><span class="na">java</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">DispatcherLeaderProcessFactory</span> <span class="nf">createFactory</span><span class="o">(</span>
        <span class="n">JobGraphStoreFactory</span> <span class="n">jobGraphStoreFactory</span><span class="o">,</span>
        <span class="n">Executor</span> <span class="n">ioExecutor</span><span class="o">,</span> <span class="n">RpcService</span> <span class="n">rpcService</span><span class="o">,</span>
        <span class="n">PartialDispatcherServices</span> <span class="n">partialDispatcherServices</span><span class="o">,</span>
        <span class="n">FatalErrorHandler</span> <span class="n">fatalErrorHandler</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">AbstractDispatcherLeaderProcess</span><span class="o">.</span><span class="na">DispatcherGatewayServiceFactory</span> <span class="n">dispatcherGatewayServiceFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultDispatcherGatewayServiceFactory</span><span class="o">(</span> <span class="n">dispatcherFactory</span><span class="o">,</span>
        <span class="n">rpcService</span><span class="o">,</span> <span class="n">partialDispatcherServices</span><span class="o">);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">SessionDispatcherLeaderProcessFactory</span><span class="o">(</span>
        <span class="n">dispatcherGatewayServiceFactory</span><span class="o">,</span>
        <span class="n">jobGraphStoreFactory</span><span class="o">,</span> <span class="n">ioExecutor</span><span class="o">,</span> <span class="n">fatalErrorHandler</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
<img alt="" src="/Users/liaomengjie/workspace/learngit/leetcode/todo/Flink/perjob%E4%B8%8Esession%E8%BF%9C%E7%AB%AF%E6%9C%80%E5%A4%A7%E5%8C%BA%E5%88%AB.png" /></p>
<p>这里需要补充一点的就是在per-job-Cluster模式下jobGraph = jobGraphRetriever.retrieveJobGraph(）是如何实现从HDFS中获取JohGraph
<div class="codehilite"><pre><span class="n">JobGraphRetriever</span><span class="o">.</span><span class="na">java</span>
<span class="n">JobGraph</span> <span class="nf">retrieveJobGraph</span><span class="o">(</span><span class="n">Configuration</span> <span class="n">configuration</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">FlinkException</span><span class="o">;</span>
</pre></div>
<div class="codehilite"><pre><span class="n">FileJobGraphRetriever</span><span class="o">.</span><span class="na">java</span>
<span class="c1">//implementation which retrieves the JobGraph}from a file on disk.</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">JobGraph</span> <span class="nf">retrieveJobGraph</span><span class="o">(</span><span class="n">Configuration</span> <span class="n">configuration</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">FlinkException</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">File</span> <span class="n">fp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">jobGraphFile</span><span class="o">);</span>

    <span class="k">try</span> <span class="o">(</span><span class="n">FileInputStream</span> <span class="n">input</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">fp</span><span class="o">);</span>
        <span class="n">ObjectInputStream</span> <span class="n">obInput</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="n">input</span><span class="o">))</span> <span class="o">{</span>
<span class="err">★</span>       <span class="kd">final</span> <span class="n">JobGraph</span> <span class="n">jobGraph</span> <span class="o">=</span> <span class="o">(</span><span class="n">JobGraph</span><span class="o">)</span> <span class="n">obInput</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">addUserClassPathsToJobGraph</span><span class="o">(</span><span class="n">jobGraph</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">jobGraph</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">FileNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">FlinkException</span><span class="o">(</span><span class="s">&quot;Could not find the JobGraph file.&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="o">|</span> <span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">FlinkException</span><span class="o">(</span><span class="s">&quot;Could not load the JobGraph from file.&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></p>
<h5 id="_7">总结<a class="headerlink" href="#_7" title="Permanent link"></a></h5>
<p>per-job模式后端逻辑如下：</p>
<p><img alt="" src="" /></p>
<h3 id="_8">总结<a class="headerlink" href="#_8" title="Permanent link"></a></h3></article></body></html>